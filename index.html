<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
<title>MS EDUCATION Pro Online Exam App - v7.5</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+Da+2:wght@400;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>

<script>
    // MathJax ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®
    MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']]
        },
        svg: {
            fontCache: 'global'
        },
        chtml: {
            scale: 1.05
        }
    };
</script>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDmReTiRc0voblz_lUX_UpjL38a6YwC23A",
      authDomain: "project1-64a93.firebaseapp.com",
      projectId: "project1-64a93",
      storageBucket: "project1-64a93.firebasestorage.app",
      messagingSenderId: "198510257374",
      appId: "1:198510257374:web:e6a1b9e74c539f5e120e4f"
    };

    let db, storage;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        storage = firebase.storage();
        console.log("Firebase initialized successfully (V8).");
    } catch (e) {
        console.error("Firebase Initialization Failed:", e);
    }

    const CONTACT_LINKS = {
        whatsapp: "https://wa.me/8801883109096", 
        facebook: "https://www.facebook.com/mubarak.hosen.37625",
        mobile: "01883109096", 
        teacherName: "‡¶Æ‡ßã‡¶¨‡¶æ‡¶∞‡¶æ‡¶ï ‡¶π‡ßã‡¶∏‡ßá‡¶®",
        teacherSchool: "‡¶Ü‡¶≤ ‡¶π‡¶æ‡¶Æ‡¶∞‡¶æ ‡¶®‡ßÇ‡¶∞‡¶æ‡¶®‡ßÄ ‡¶Æ‡¶æ‡¶¶‡¶∞‡¶æ‡¶∏‡¶æ"
    };
    
    let questions=[], currentQ=0, score=0, studentName="", studentClass="", studentMobile="", studentGender="", examTitle="", examID="", durationMinutes=0;
    let studentAnswers = []; 
    let timerInterval;
    let currentEditExamID = null; 

    let teacherPanel, studentStartPanel, quizPanel, resultPanel, errorMessageDiv, resultListPanel, savedExamsPanel, newExamPanel;

    let canvas;
    let isDrawingMode = true; 
    let currentQuestionIndexForDrawing = -1; 
    let pathSimplifierEnabled = false; 

    const mathPlaceholder = "‡¶¨‡ßÄ‡¶ú‡¶ó‡¶£‡¶ø‡¶§ ‡¶¨‡¶æ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶≤‡¶ø‡¶ñ‡¶§‡ßá $ (A+B)^2 $ ‡¶¨‡¶æ $$ \int x^2 dx $$ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®";
    const sampleQuestions = [
        `‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶∞‡¶æ‡¶ú‡¶ß‡¶æ‡¶®‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶ï‡ßÄ? (AI ‡¶∏‡¶æ‡¶ú‡ßá‡¶∂‡¶®)`, 
        `‡¶≠‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶¨‡ßá‡¶ó‡ßá‡¶∞ ‡¶ó‡ßÅ‡¶£‡¶´‡¶≤‡¶ï‡ßá ‡¶ï‡ßÄ ‡¶¨‡¶≤‡ßá? (AI ‡¶∏‡¶æ‡¶ú‡ßá‡¶∂‡¶®)`, 
        `‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø ‡¶ï‡ßã‡¶® ‡¶¶‡¶ø‡¶ï‡ßá ‡¶ì‡¶†‡ßá? (AI ‡¶∏‡¶æ‡¶ú‡ßá‡¶∂‡¶®)`,
        `$\\(A+B\\)^2$-‡¶è‡¶∞ ‡¶∏‡ßÇ‡¶§‡ßç‡¶∞ ‡¶ï‡ßÄ? (${mathPlaceholder})`, 
        `‡¶ú‡ßÄ‡¶¨‡¶¶‡ßá‡¶π‡ßá‡¶∞ ‡¶ï‡ßç‡¶∑‡ßÅ‡¶¶‡ßç‡¶∞‡¶§‡¶Æ ‡¶è‡¶ï‡¶ï ‡¶ï‡ßã‡¶®‡¶ü‡¶ø? (AI ‡¶∏‡¶æ‡¶ú‡ßá‡¶∂‡¶®)`, 
        `‡¶Ü‡¶≤‡ßã‡¶ï‡¶¨‡¶∞‡ßç‡¶∑ ‡¶ï‡¶ø‡¶∏‡ßá‡¶∞ ‡¶è‡¶ï‡¶ï? (AI ‡¶∏‡¶æ‡¶ú‡ßá‡¶∂‡¶®)`,
        `$\\sin^2\\theta + \\cos^2\\theta = $ ‡¶ï‡¶§? (${mathPlaceholder})`,
        `‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡ßÉ‡¶§‡ßç‡¶§‡ßá‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶∏‡¶æ‡¶∞‡ßç‡¶ß $r$ ‡¶π‡¶≤‡ßá, ‡¶ï‡ßç‡¶∑‡ßá‡¶§‡ßç‡¶∞‡¶´‡¶≤ ‡¶ï‡¶§? (${mathPlaceholder})`,
        `‡ß™, ‡ß´, ‡ß¨, ‡ß≠, ‡ßÆ ‡¶è‡¶∞ ‡¶ó‡ßú ‡¶ï‡¶§? (AI ‡¶∏‡¶æ‡¶ú‡ßá‡¶∂‡¶®)`, 
        `‡¶ú‡¶æ‡¶§‡ßÄ‡¶Ø‡¶º ‡¶´‡ßÅ‡¶≤ ‡¶ï‡ßÄ? (AI ‡¶∏‡¶æ‡¶ú‡ßá‡¶∂‡¶®)`, 
        `‡¶ï‡ßã‡¶®‡¶ü‡¶ø ‡¶ï‡¶Æ‡ßç‡¶™‡¶ø‡¶â‡¶ü‡¶æ‡¶∞‡ßá‡¶∞ ‡¶Ü‡¶â‡¶ü‡¶™‡ßÅ‡¶ü ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏? (AI ‡¶∏‡¶æ‡¶ú‡ßá‡¶∂‡¶®)`,
    ];
    let questionCounter = 1;
    
    const banglaOptions = ['‡¶ï', '‡¶ñ', '‡¶ó', '‡¶ò'];

    // ‡¶ó‡ßç‡¶∞‡ßá‡¶°‡¶ø‡¶Ç ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ
    const gradingSystem = [
        { minPercent: 80, grade: 'A+', gpa: 5.0, remark: '‡¶Ö‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£' },
        { minPercent: 70, grade: 'A', gpa: 4.0, remark: '‡¶ñ‡ßÅ‡¶¨ ‡¶≠‡¶æ‡¶≤‡ßã' },
        { minPercent: 60, grade: 'A-', gpa: 3.5, remark: '‡¶≠‡¶æ‡¶≤‡ßã' },
        { minPercent: 50, grade: 'B', gpa: 3.0, remark: '‡¶Æ‡ßã‡¶ü‡¶æ‡¶Æ‡ßÅ‡¶ü‡¶ø' },
        { minPercent: 40, grade: 'C', gpa: 2.0, remark: '‡¶∏‡¶®‡ßç‡¶§‡ßã‡¶∑‡¶ú‡¶®‡¶ï' },
        { minPercent: 33, grade: 'D', gpa: 1.0, remark: '‡¶™‡¶æ‡¶∏' },
        { minPercent: 0, grade: 'F', gpa: 0.0, remark: '‡¶´‡ßá‡¶≤' }
    ];

    // ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶≠‡ßá‡¶∞‡¶ø‡ßü‡ßá‡¶¨‡¶≤
    let systemSettings = {
        showResultToStudent: true,
        autoShareResult: false,
        examActiveStatus: true,
        allowRetakeExam: false,
        showCorrectAnswer: false,
        requireStudentPhoto: false
    };

    function injectContactLinks() {
        const mobileLinkElements = document.querySelectorAll('.mobile-link-text');
        mobileLinkElements.forEach(el => el.innerText = CONTACT_LINKS.mobile);
        
        const teacherNameElements = document.querySelectorAll('.teacher-name-display');
        teacherNameElements.forEach(el => el.innerText = CONTACT_LINKS.teacherName);
        
        const schoolNameElements = document.querySelectorAll('.teacher-school-display');
        schoolNameElements.forEach(el => el.innerText = CONTACT_LINKS.teacherSchool);
        
        const whatsappLinkElements = document.querySelectorAll('[id^="whatsappLink"]');
        whatsappLinkElements.forEach(el => el.href = CONTACT_LINKS.whatsapp);

        const facebookLinkElements = document.querySelectorAll('[id^="facebookLink"]');
        facebookLinkElements.forEach(el => el.href = CONTACT_LINKS.facebook);

        const mobileLinkA = document.querySelectorAll('a[href^="tel:"]');
        mobileLinkA.forEach(el => el.href = `tel:${CONTACT_LINKS.mobile}`);

        const contactHTML = `
            <hr style="margin-top: 20px; border-top: 1px dashed #fff;">
            <p class="duplicate-contact-header">
                <i class="fas fa-hand-point-right"></i> ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®:
            </p>
            <p style="text-align: center; margin: 10px 0;" class="contact-info-list">
                <strong style="color: var(--danger-color);" class="teacher-name-display">${CONTACT_LINKS.teacherName}</strong><br>
                <i class="fas fa-mobile-alt"></i> Mobile: <a href="tel:${CONTACT_LINKS.mobile}" class="mobile-link contact-mobile-link-dark" style="font-weight: bold;">${CONTACT_LINKS.mobile}</a><br>
                <i class="fab fa-whatsapp" style="color: #25D366;"></i> WhatsApp: <a href="${CONTACT_LINKS.whatsapp}" target="_blank" style="color: #25D366; font-weight: bold;">‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</a><br>
                <i class="fab fa-facebook" style="color: #1877F2;"></i> Facebook: <a href="${CONTACT_LINKS.facebook}" target="_blank" style="color: #1877F2; font-weight: bold;">‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</a>
            </p>
        `;

        const duplicateContactBlock = document.getElementById('duplicateContactBlock');
        const duplicateContactBlock2 = document.getElementById('duplicateContactBlock2');

        if (duplicateContactBlock) duplicateContactBlock.innerHTML = contactHTML;
        if (duplicateContactBlock2) duplicateContactBlock2.innerHTML = contactHTML;
        
        const contactInfoBlock = document.getElementById('contactInfoBlock');
        if (contactInfoBlock) {
             contactInfoBlock.innerHTML = `
                <p style="font-size: 18px; color: var(--danger-color); font-weight: 700; text-align: center;">
                    <i class="fas fa-hand-point-right"></i> ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®:
                </p>
                <p style="text-align: center; margin: 10px 0;">
                    <strong style="color: var(--danger-color);" class="teacher-name-display">${CONTACT_LINKS.teacherName}</strong><br>
                    <i class="fas fa-mobile-alt"></i> Mobile: <a href="tel:${CONTACT_LINKS.mobile}" class="mobile-link" style="color: var(--primary-color); font-weight: bold;">${CONTACT_LINKS.mobile}</a><br>
                    <i class="fab fa-whatsapp" style="color: #25D366;"></i> WhatsApp: <a href="${CONTACT_LINKS.whatsapp}" target="_blank" id="whatsappLink" style="color: #25D366; font-weight: bold;">‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</a><br>
                    <i class="fab fa-facebook" style="color: #1877F2;"></i> Facebook: <a href="${CONTACT_LINKS.facebook}" target="_blank" id="facebookLink" style="color: #1877F2; font-weight: bold;">‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</a>
                </p>
            `;
        }
    }

    function getBaseUrl() {
        const url = window.location.href.split('?')[0].split('#')[0];
        if (url.endsWith('.html') || url.endsWith('.htm')) {
            return url;
        }
        return url.endsWith('/') ? url : url + '/';
    }

    // ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶Ü‡¶á‡¶ï‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Æ‡ßá‡¶®‡ßÅ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    window.toggleSettingsMenu = function() {
        const settingsMenu = document.querySelector('#teacher .settings-menu');
        if (settingsMenu) {
            settingsMenu.style.display = settingsMenu.style.display === 'block' ? 'none' : 'block';
        }
    }

    // ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
    async function loadSettings() {
        try {
            if (!db) return;
            
            const docSnap = await db.collection("system_settings").doc("app_settings").get();
            if (docSnap.exists) {
                systemSettings = { ...systemSettings, ...docSnap.data() };
                updateSettingsUI();
            }
        } catch (e) {
            console.error("Settings load failed:", e);
        }
    }

    // ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ UI ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
    function updateSettingsUI() {
        const showResultSwitch = document.getElementById('showResultSwitch');
        const autoShareSwitch = document.getElementById('autoShareSwitch');
        const examActiveSwitch = document.getElementById('examActiveSwitch');
        const allowRetakeSwitch = document.getElementById('allowRetakeSwitch');
        const showAnswerSwitch = document.getElementById('showAnswerSwitch');
        const requirePhotoSwitch = document.getElementById('requirePhotoSwitch');
        
        if (showResultSwitch) showResultSwitch.checked = systemSettings.showResultToStudent;
        if (autoShareSwitch) autoShareSwitch.checked = systemSettings.autoShareResult;
        if (examActiveSwitch) examActiveSwitch.checked = systemSettings.examActiveStatus;
        if (allowRetakeSwitch) allowRetakeSwitch.checked = systemSettings.allowRetakeExam;
        if (showAnswerSwitch) showAnswerSwitch.checked = systemSettings.showCorrectAnswer;
        if (requirePhotoSwitch) requirePhotoSwitch.checked = systemSettings.requireStudentPhoto;
    }

    // ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ
    window.saveSettings = async function() {
        try {
            const showResultSwitch = document.getElementById('showResultSwitch');
            const autoShareSwitch = document.getElementById('autoShareSwitch');
            const examActiveSwitch = document.getElementById('examActiveSwitch');
            const allowRetakeSwitch = document.getElementById('allowRetakeSwitch');
            const showAnswerSwitch = document.getElementById('showAnswerSwitch');
            const requirePhotoSwitch = document.getElementById('requirePhotoSwitch');
            
            systemSettings.showResultToStudent = showResultSwitch ? showResultSwitch.checked : true;
            systemSettings.autoShareResult = autoShareSwitch ? autoShareSwitch.checked : false;
            systemSettings.examActiveStatus = examActiveSwitch ? examActiveSwitch.checked : true;
            systemSettings.allowRetakeExam = allowRetakeSwitch ? allowRetakeSwitch.checked : false;
            systemSettings.showCorrectAnswer = showAnswerSwitch ? showAnswerSwitch.checked : false;
            systemSettings.requireStudentPhoto = requirePhotoSwitch ? requirePhotoSwitch.checked : false;

            if (!db) { throw new Error("Firebase DB not initialized."); }

            await db.collection("system_settings").doc("app_settings").set(systemSettings);
            
            alert("‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            const settingsMenu = document.querySelector('#teacher .settings-menu');
            if (settingsMenu) {
                settingsMenu.style.display = 'none';
            }
            
        } catch (e) {
            console.error("Settings save failed:", e);
            alert(`‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ${e.message}`);
        }
    }

    let currentTeacherView = 'newExam'; 
    window.toggleTeacherPanel = function(view) {
        newExamPanel.style.display = 'none';
        savedExamsPanel.style.display = 'none';
        resultListPanel.style.display = 'none';
        document.getElementById('printQuestionSheet').style.display = 'none'; 
        document.getElementById('toolsPanel').style.display = 'none';

        document.querySelectorAll('.teacher-nav-btn').forEach(btn => btn.classList.remove('active-nav'));

        if (view === 'newExam') {
            newExamPanel.style.display = 'block';
            resetNewExamPanel(); 
            currentTeacherView = 'newExam';
            document.getElementById('toggleNewExamBtn').classList.add('active-nav');
        } else if (view === 'savedExams') {
            savedExamsPanel.style.display = 'block';
            loadSavedExams();
            currentTeacherView = 'savedExams';
            document.getElementById('toggleSavedExamBtn').classList.add('active-nav');
        } else if (view === 'results') {
            resultListPanel.style.display = 'block';
            updateResultTable();
            currentTeacherView = 'results';
            document.getElementById('toggleResultBtn').classList.add('active-nav');
        } else if (view === 'tools') {
            document.getElementById('toolsPanel').style.display = 'block';
            currentTeacherView = 'tools';
            document.getElementById('toggleToolsBtn').classList.add('active-nav');
        }
        
        // ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶Æ‡ßá‡¶®‡ßÅ ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã
        const settingsMenu = document.querySelector('#teacher .settings-menu');
        if (settingsMenu) {
            settingsMenu.style.display = 'none';
        }
    }

    function resetNewExamPanel() {
        currentEditExamID = null;
        document.getElementById('examTitle').value = '';
        document.getElementById('examDuration').value = ''; 
        document.getElementById('examIdDisplay').style.display = 'none';
        document.getElementById('examIdDisplay').innerText = '';
        
        const formsDiv = document.getElementById('questionForms');
        formsDiv.innerHTML = '';
        questionCounter = 1;
        addQuestion(); 
        
        document.getElementById('saveOrUpdateExamBtn').style.display = 'block';
        document.getElementById('generateLinkBtn').style.display = 'none';
        document.getElementById('examLinkContainer').style.display = 'none';
        document.getElementById('printExamBtn').style.display = 'none';
    }

    window.addQuestion = function(qText = '', opts = ['', '', '', ''], correctAns = '0', imgUrl = ''){
        const formsDiv=document.getElementById('questionForms');
        const newQContainer=document.createElement('div');
        newQContainer.classList.add('question-container');
        newQContainer.setAttribute('data-q-index', questionCounter);
        
        const placeholderText = qText || sampleQuestions[(questionCounter-1) % sampleQuestions.length];
        const questionId = `q_text_${questionCounter}`;
        const fileInputId = `q_file_${questionCounter}`;
        const containerIndex = questionCounter;

        newQContainer.innerHTML=`
        <hr>
        <div class="question-header-bar">
            <label>‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ${containerIndex}:</label>
            <div class="header-actions">
                <button type="button" class="utility-btn drawing-btn" onclick="openDiagramTool(${containerIndex})" title="‡¶¨‡ßÄ‡¶ú‡¶ó‡¶£‡¶ø‡¶§/‡¶ú‡ßç‡¶Ø‡¶æ‡¶Æ‡¶ø‡¶§‡¶ø ‡¶ö‡¶ø‡¶§‡ßç‡¶∞ ‡¶Ü‡¶Å‡¶ï‡ßÅ‡¶®">
                    <i class="fas fa-pencil-ruler"></i> ‡¶ö‡¶ø‡¶§‡ßç‡¶∞ ‡¶Ü‡¶Å‡¶ï‡ßÅ‡¶®
                </button>
                <button type="button" class="utility-btn file-upload-btn" onclick="document.getElementById('${fileInputId}').click()" title="‡¶´‡¶æ‡¶á‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶ö‡¶ø‡¶§‡ßç‡¶∞ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®">
                    <i class="fas fa-cloud-upload-alt"></i> ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶°
                </button>
                <input type="file" id="${fileInputId}" style="display: none;" accept="image/*" onchange="uploadImageFromFile(this, ${containerIndex})">
                <button type="button" class="utility-btn preview-btn" onclick="previewQuestion('${questionId}')" title="‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶ï‡¶∞‡ßÅ‡¶®"><i class="fas fa-eye"></i> ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â</button>
                <button type="button" class="utility-btn remove-btn" onclick="removeQuestion(this)" title="‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶¶‡¶ø‡¶®"><i class="fas fa-trash-alt"></i></button>
            </div>
        </div>

        <div class="input-group">
            <input type="text" class="qText" id="${questionId}" placeholder="${placeholderText}" value="${qText}">
            <input type="hidden" class="qImageURL" value="${imgUrl}"> 
        </div>
        
        <div class="image-preview" id="diagram_preview_${containerIndex}">
            ${imgUrl ? `<img src="${imgUrl}" style="max-width: 100%; border: 1px solid #ddd; margin-top: 5px;">
            <button type="button" class="utility-btn remove-img-btn" onclick="removeQuestionImage(this)" style="background: var(--danger-color) !important; width: 100px; margin-top: 5px;"><i class="fas fa-trash-alt"></i> ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>` : ''}
        </div>

        <div class="preview-output" id="preview_output_${questionId}" style="display: none;">
            <p><strong>‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â:</strong></p>
            <div class="math-preview"></div>
        </div>

        <div class="input-group options-group">
            <input type="text" class="opt small-input" placeholder="‡¶Ö‡¶™‡¶∂‡¶® ‡ßß (‡¶ï)" value="${opts[0]}">
            <input type="text" class="opt small-input" placeholder="‡¶Ö‡¶™‡¶∂‡¶® ‡ß® (‡¶ñ)" value="${opts[1]}">
            <input type="text" class="opt small-input" placeholder="‡¶Ö‡¶™‡¶∂‡¶® ‡ß© (‡¶ó)" value="${opts[2]}">
            <input type="text" class="opt small-input" placeholder="‡¶Ö‡¶™‡¶∂‡¶® ‡ß™ (‡¶ò)" value="${opts[3]}">
        </div>
        <div class="input-group correct-select-group">
            <label>‡¶∏‡¶†‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞:</label>
            <select class="correctAnswer small-select">
                <option value="0" ${correctAns == '0' ? 'selected' : ''}>‡ßß (‡¶ï)</option>
                <option value="1" ${correctAns == '1' ? 'selected' : ''}>‡ß® (‡¶ñ)</option>
                <option value="2" ${correctAns == '2' ? 'selected' : ''}>‡ß© (‡¶ó)</option>
                <option value="3" ${correctAns == '3' ? 'selected' : ''}>‡ß™ (‡¶ò)</option>
            </select>
        </div>
        `;
        formsDiv.appendChild(newQContainer);
        questionCounter++;
    }

    window.removeQuestionImage = function(buttonElement) {
        const imgPreviewDiv = buttonElement.closest('.image-preview');
        const container = buttonElement.closest('.question-container');
        
        if (container) {
            const imgURLInput = container.querySelector('.qImageURL');
            if (imgURLInput) {
                imgURLInput.value = ''; 
            }
            
            if (imgPreviewDiv) {
                imgPreviewDiv.innerHTML = ''; 
                alert("‡¶ö‡¶ø‡¶§‡ßç‡¶∞ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
            }
        } else {
             alert("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§");
        }
    }
    
    window.uploadImageFromFile = async function(fileInput, qIndex) {
        const file = fileInput.files[0];
        if (!file) return;

        const container = document.querySelector(`.question-container[data-q-index="${qIndex}"]`);
        const imgPreviewDiv = container.querySelector('.image-preview');
        imgPreviewDiv.innerHTML = '<p style="text-align: center; color: var(--primary-color);"><i class="fas fa-spinner fa-spin"></i> ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>';

        const imgURL = await uploadFileToStorage(file, examID, `file_upload_${qIndex}`);

        if (imgURL) {
            const imgURLInput = container.querySelector('.qImageURL');
            imgURLInput.value = imgURL; 
            
            imgPreviewDiv.innerHTML = `
                <img src="${imgURL}" style="max-width: 100%; border: 1px solid #ddd; margin-top: 5px;">
                <button type="button" class="utility-btn remove-img-btn" onclick="removeQuestionImage(this)" style="background: var(--danger-color) !important; width: 100px; margin-top: 5px;"><i class="fas fa-trash-alt"></i> ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
            `;

            alert("‡¶´‡¶æ‡¶á‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶ö‡¶ø‡¶§‡ßç‡¶∞ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ì ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
        } else {
            imgPreviewDiv.innerHTML = '';
            alert("‡¶ö‡¶ø‡¶§‡ßç‡¶∞ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá Firebase Rules (Storage) ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        }
    }

    window.openDiagramTool = function(qIndex) {
        currentQuestionIndexForDrawing = qIndex;
        document.getElementById('diagramModal').style.display = 'block';
        initCanvas();
    }

    window.closeDiagramModal = function() {
        document.getElementById('diagramModal').style.display = 'none';
        currentQuestionIndexForDrawing = -1;
    }

    function initCanvas() {
        const canvasContainer = document.getElementById('canvas-container');
        const containerWidth = canvasContainer.offsetWidth;
        const canvasSize = Math.min(containerWidth, 600); 

        if (canvas) {
            canvas.dispose(); 
        }

        canvas = new fabric.Canvas('diagramCanvas', {
            isDrawingMode: true,
            width: canvasSize,
            height: canvasSize * 0.75,
            backgroundColor: '#fff'
        });
        isDrawingMode = true; 
        pathSimplifierEnabled = false; 

        canvas.freeDrawingBrush.width = 3;
        canvas.freeDrawingBrush.color = '#000';

        document.getElementById('colorPicker').onchange = (e) => {
            canvas.freeDrawingBrush.color = e.target.value;
        };
        document.getElementById('brushSize').onchange = (e) => {
            canvas.freeDrawingBrush.width = parseInt(e.target.value, 10);
        };
        document.getElementById('drawingMode').onchange = (e) => {
            isDrawingMode = e.target.checked;
            canvas.isDrawingMode = isDrawingMode;
            if (!isDrawingMode) {
                canvas.selection = true;
                canvas.forEachObject(obj => obj.selectable = true);
            } else {
                canvas.selection = false;
                canvas.forEachObject(obj => obj.selectable = false);
            }
        };

        canvas.on('path:created', (opt) => {
            if (pathSimplifierEnabled && opt.path) {
                const path = opt.path;
                const pathPoints = path.path;
                
                if (pathPoints.length > 5) {
                    const startX = pathPoints[0][1];
                    const startY = pathPoints[0][2];
                    const endX = pathPoints[pathPoints.length - 1][1];
                    const endY = pathPoints[pathPoints.length - 1][2];

                    const deltaX = Math.abs(startX - endX);
                    const deltaY = Math.abs(startY - endY);
                    const totalLength = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

                    if (totalLength > 50) { 
                        const line = new fabric.Line([startX, startY, endX, endY], {
                            stroke: path.stroke,
                            strokeWidth: path.strokeWidth,
                            strokeLineCap: path.strokeLineCap,
                            selectable: true,
                            evented: true
                        });
                        canvas.remove(path); 
                        canvas.add(line); 
                        canvas.renderAll();
                        return;
                    }
                }
            }
        });
    }

    window.toggleSmartDrawing = function() {
        pathSimplifierEnabled = !pathSimplifierEnabled;
        const btn = document.getElementById('smartDrawingBtn');
        if (pathSimplifierEnabled) {
            btn.classList.add('active-smart');
            btn.innerHTML = '<i class="fas fa-lightbulb"></i> ‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶Æ‡ßã‡¶°: ‡¶Ö‡¶®';
            isDrawingMode = true; 
            canvas.isDrawingMode = true;
            document.getElementById('drawingMode').checked = true;
            alert("‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶°‡ßç‡¶∞‡ßü‡¶ø‡¶Ç ‡¶Æ‡ßã‡¶° ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü! ‡¶è‡¶ñ‡¶® ‡¶π‡¶æ‡¶§‡ßá ‡¶Ü‡¶Å‡¶ï‡¶æ ‡¶≤‡¶æ‡¶á‡¶® ‡¶ü‡¶æ‡¶®‡¶≤‡ßá ‡¶§‡¶æ ‡¶∏‡ßã‡¶ú‡¶æ ‡¶π‡ßü‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§");

        } else {
            btn.classList.remove('active-smart');
            btn.innerHTML = '<i class="fas fa-lightbulb"></i> ‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶Æ‡ßã‡¶°: ‡¶Ö‡¶´';
            alert("‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶°‡ßç‡¶∞‡ßü‡¶ø‡¶Ç ‡¶Æ‡ßã‡¶° ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡ßü‡•§");
        }
    }

    window.addGeometricText = function() {
        if (!canvas) return;
        const textInput = document.getElementById('geometricText');
        let text = textInput.value.trim();
        if (!text) {
            alert("‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶¶‡¶ø‡¶®‡•§");
            return;
        }

        const fText = new fabric.Text(text, {
            left: canvas.width / 2,
            top: canvas.height / 2,
            fontSize: 20,
            fill: document.getElementById('colorPicker').value,
            fontWeight: 'bold',
            selectable: true
        });
        
        canvas.add(fText);
        canvas.renderAll();
        textInput.value = ''; 
    }

    window.addCircle = function() {
        if (!canvas) return;
        const circle = new fabric.Circle({
            radius: 50,
            fill: '', 
            stroke: document.getElementById('colorPicker').value,
            strokeWidth: parseInt(document.getElementById('brushSize').value, 10),
            left: canvas.width / 2 - 50,
            top: canvas.height / 2 - 50,
            selectable: true
        });
        canvas.add(circle);
        canvas.renderAll();
    }
    
    window.addTriangle = function() {
        if (!canvas) return;
        const triangle = new fabric.Triangle({
            width: 100,
            height: 100,
            fill: '',
            stroke: document.getElementById('colorPicker').value,
            strokeWidth: parseInt(document.getElementById('brushSize').value, 10),
            left: canvas.width / 2 - 50,
            top: canvas.height / 2 - 50,
            selectable: true
        });
        canvas.add(triangle);
        canvas.renderAll();
    }

    window.addAngleText = function() {
        if (!canvas) return;
        const angleInput = document.getElementById('angleInput');
        let text = angleInput.value.trim();
        if (!text) {
            alert("‡¶ï‡ßã‡¶£‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶® ‡¶¶‡¶ø‡¶®‡•§");
            return;
        }

        if (!text.includes('¬∞')) {
            text += '¬∞';
        }

        const fText = new fabric.Text(text, {
            left: canvas.width / 2,
            top: canvas.height / 2 + 30, 
            fontSize: 18,
            fill: document.getElementById('colorPicker').value,
            fontWeight: 'bold',
            selectable: true
        });
        
        canvas.add(fText);
        canvas.renderAll();
        angleInput.value = ''; 
    }

    window.clearCanvas = function() {
        if (canvas) {
            canvas.clear();
            canvas.setBackgroundColor('#fff', canvas.renderAll.bind(canvas));
        }
    }

    async function uploadFileToStorage(file, examId, suffix = 'diagram') {
        if (!storage) {
            alert("Firebase Storage ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§");
            return null;
        }
        
        const timestamp = new Date().getTime();
        const cleanedExamId = examId || "TEMP";
        const storageRef = storage.ref(`diagrams/${cleanedExamId}_${suffix}_${timestamp}.png`);
        
        try {
            const uploadTask = storageRef.put(file);
            await uploadTask;
            const downloadURL = await storageRef.getDownloadURL();
            return downloadURL;

        } catch (error) {
            console.error("‡¶ö‡¶ø‡¶§‡ßç‡¶∞ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•:", error);
            alert(`‡¶ö‡¶ø‡¶§‡ßç‡¶∞ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶ï‡¶æ‡¶∞‡¶£: ${error.message}`);
            return null;
        }
    }

    window.saveDiagram = async function() {
        if (!canvas) return;

        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
        
        const saveBtn = document.getElementById('saveDiagramBtn');
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
        saveBtn.disabled = true;

        const currentExamID = examID || "TEMP_DIAGRAM"; 
        const imgURL = await uploadFileToStorage(blob, currentExamID, 'canvas_drawing');

        saveBtn.innerHTML = '<i class="fas fa-save"></i> ‡¶ö‡¶ø‡¶§‡ßç‡¶∞ ‡¶∏‡ßá‡¶≠ ‡¶ì ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®';
        saveBtn.disabled = false;

        if (imgURL) {
            const container = document.querySelector(`.question-container[data-q-index="${currentQuestionIndexForDrawing}"]`);
            if (container) {
                const imgURLInput = container.querySelector('.qImageURL');
                const imgPreviewDiv = container.querySelector('.image-preview');

                imgURLInput.value = imgURL; 
                
                imgPreviewDiv.innerHTML = `
                    <img src="${imgURL}" style="max-width: 100%; border: 1px solid #ddd; margin-top: 5px;">
                    <button type="button" class="utility-btn remove-img-btn" onclick="removeQuestionImage(this)" style="background: var(--danger-color) !important; width: 100px; margin-top: 5px;"><i class="fas fa-trash-alt"></i> ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
                `;

                alert("‡¶ö‡¶ø‡¶§‡ßç‡¶∞ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ì ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
                closeDiagramModal();
            } else {
                alert("‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ü‡¶ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶∏‡ßá‡¶≠ ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡•§");
            }
        }
    }

    window.saveExam = async function(shouldGenerateLink) {
        examTitle = document.getElementById('examTitle').value.trim();
        durationMinutes = parseInt(document.getElementById('examDuration').value.trim());

        if (!examTitle) { alert("‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®!"); return; }
        if (isNaN(durationMinutes) || durationMinutes <= 0) { alert("‡¶∏‡¶†‡¶ø‡¶ï ‡¶∏‡¶Æ‡¶Ø‡¶º‡¶∏‡ßÄ‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶® (‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü‡ßá)!"); return; }

        questions = [];
        const qContainers = document.getElementsByClassName('question-container');
        
        const optsAll = document.getElementsByClassName('opt');
        const correctAll = document.getElementsByClassName('correctAnswer');
        let optIndex = 0;

        for (let i = 0; i < qContainers.length; i++) {
            const container = qContainers[i];
            const q = container.querySelector('.qText').value.trim();
            const imgUrl = container.querySelector('.qImageURL').value.trim(); 

            if (!q) { alert(`‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ${i + 1} ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®!`); return; }
            const options = [];
            let allOptionsFilled = true;
            for (let j = 0; j < 4; j++) {
                const val = optsAll[optIndex].value.trim();
                if (!val) {
                    alert(`‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ${i + 1}-‡¶è‡¶∞ ‡¶Ö‡¶™‡¶∂‡¶® ${j + 1} ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®!`);
                    allOptionsFilled = false;
                    break;
                }
                options.push(val);
                optIndex++;
            }
            if (!allOptionsFilled) return;
            questions.push({
                question: q,
                options: options,
                answer: parseInt(correctAll[i].value),
                qImageURL: imgUrl 
            });
        }
        if (questions.length === 0) {
            alert("‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®!");
            return;
        }

        examID = "PRO" + Math.random().toString(36).substr(2, 9).toUpperCase();
        currentEditExamID = null; 

        const examData = {
            examID: examID,
            title: examTitle,
            duration: durationMinutes,
            questions: questions,
            showResult: systemSettings.showResultToStudent, // ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡ßá‡¶ì‡ßü‡¶æ
            isActive: systemSettings.examActiveStatus, // ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡ßá‡¶ì‡ßü‡¶æ
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            if (!db) { throw new Error("Firebase DB not initialized."); }

            await db.collection("exams").doc(examID).set(examData); 

            if (shouldGenerateLink) {
                generateExamLinkDisplay(examID, examTitle, durationMinutes);
            } else {
                document.getElementById('examIdDisplay').style.display = 'block';
                document.getElementById('examIdDisplay').innerText = `‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ID: ${examID} | ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶®‡¶§‡ßÅ‡¶®‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`;
                document.getElementById('saveOrUpdateExamBtn').style.display = 'none'; 
                document.getElementById('generateLinkBtn').style.display = 'block'; 
                document.getElementById('printExamBtn').style.display = 'block';

                alert(`"${examTitle}" ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶®‡¶§‡ßÅ‡¶®‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶è‡¶ñ‡¶® ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®‡•§`);
            }

        } catch (e) {
            console.error("‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£/‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•:", e);
            alert(`‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶ï‡¶æ‡¶∞‡¶£: ${e.message}`);
        }
    }
    
    window.printNewExamQuestions = function() {
        const title = document.getElementById('examTitle').value.trim();
        const duration = document.getElementById('examDuration').value.trim();
        const qContainers = document.getElementsByClassName('question-container');
        const sheetContainer = document.getElementById('printQuestionSheet');
        const printContent = document.getElementById('printQuestionContent');
        
        const logoInput = document.getElementById('logoUploadInput');
        let logoHTML = '';
        
        if (logoInput && logoInput.files && logoInput.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const logoURL = e.target.result;
                logoHTML = `<div style="text-align: center; margin-bottom: 10px;">
                    <img src="${logoURL}" alt="‡¶≤‡ßã‡¶ó‡ßã" style="max-height: 80px; max-width: 200px;">
                </div>`;
                generatePrintContent();
            };
            reader.readAsDataURL(logoInput.files[0]);
        } else {
            generatePrintContent();
        }
        
        function generatePrintContent() {
            let html = `
                <div class="print-header-section">
                    ${logoHTML}
                    <h1 style="text-align: center; color: var(--primary-color); font-size: 28px; margin-bottom: 5px;">MS EDUCATION ONLINE EXAM</h1>
                    <h2 style="text-align: center; color: var(--danger-color); font-size: 22px; border-bottom: 2px solid #ccc; padding-bottom: 5px; margin-bottom: 10px;">${title || "‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ"}</h2>
                    <p style="text-align: center; font-size: 16px; font-weight: 700; margin-top: 10px; margin-bottom: 15px;">
                        ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï: <span class="teacher-name-display">${CONTACT_LINKS.teacherName}</span> | ‡¶∏‡¶Æ‡¶Ø‡¶º: ${duration} ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü
                    </p>
                    <hr style="border-top: 2px solid var(--secondary-color); margin-bottom: 15px;">
                </div>
                
                <div class="print-questions-section" style="column-count: 2; column-gap: 20px;">
            `;
            
            const optsAll = document.getElementsByClassName('opt');
            const correctAll = document.getElementsByClassName('correctAnswer');
            let optIndex = 0;
            let questionNumber = 1;

            for (let i = 0; i < qContainers.length; i++) {
                const container = qContainers[i];
                const q = container.querySelector('.qText').value.trim();
                const imgUrl = container.querySelector('.qImageURL').value.trim(); 
                
                const options = [];
                for (let j = 0; j < 4; j++) {
                    options.push(optsAll[optIndex].value.trim());
                    optIndex++;
                }
                
                const correctAnswerIndex = parseInt(correctAll[i].value);
                const correctAnswer = options[correctAnswerIndex];
                const correctOptionChar = banglaOptions[correctAnswerIndex];
                
                const imageHTML = imgUrl 
                    ? `<div style="text-align: center; margin-bottom: 8px; break-inside: avoid;">
                        <img src="${imgUrl}" alt="Question Diagram" style="max-width: 95%; border: 1px solid #ddd; border-radius: 3px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                       </div>` 
                    : '';

                html += `
                    <div class="print-question-item" style="break-inside: avoid; page-break-inside: avoid; margin-bottom: 15px; padding: 8px; border: 1px solid #eee; border-radius: 5px; background: #f9f9f9;">
                        ${imageHTML}
                        <p style="font-weight: 700; font-size: 14px; margin: 5px 0 8px 0; line-height: 1.4;">
                            ${questionNumber}. <span class="math-text">${q}</span>
                        </p>
                        <div class="print-options" style="margin-left: 5px;">
                            ${options.map((opt, idx) => `
                                <p style="margin: 3px 0 3px 15px; font-size: 13px; line-height: 1.3;">
                                    ${banglaOptions[idx]}. <span class="math-text-option">${opt}</span>
                                </p>
                            `).join('')}
                        </div>
                        <p style="font-size: 12px; color: #d32f2f; font-weight: bold; margin-top: 5px; padding: 3px; border-top: 1px dashed #ddd;">
                            <i class="fas fa-check-circle"></i> ‡¶∏‡¶†‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞: ${correctOptionChar}. ${correctAnswer}
                        </p>
                    </div>
                `;
                
                questionNumber++;
            }
            
            html += `</div>`; 
            
            html += `
                <div class="print-answer-key" style="margin-top: 30px; page-break-before: always; break-before: page;">
                    <h3 style="text-align: center; color: var(--danger-color); border-bottom: 2px solid #d32f2f; padding-bottom: 5px; margin-bottom: 15px;">
                        <i class="fas fa-key"></i> ‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶™‡¶§‡ßç‡¶∞
                    </h3>
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="background-color: #f5f5f5;">
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶®‡¶Ç</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">‡¶∏‡¶†‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            optIndex = 0;
            for (let i = 0; i < qContainers.length; i++) {
                const correctAnswerIndex = parseInt(correctAll[i].value);
                const correctOptionChar = banglaOptions[correctAnswerIndex];
                
                html += `
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center; font-weight: bold;">${i + 1}</td>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center; color: #d32f2f; font-weight: bold;">${correctOptionChar}</td>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">‡ßß</td>
                    </tr>
                `;
                
                for (let j = 0; j < 4; j++) {
                    optIndex++;
                }
            }
            
            html += `
                        </tbody>
                        <tfoot>
                            <tr style="background-color: #f0f0f0; font-weight: bold;">
                                <td colspan="2" style="border: 1px solid #ddd; padding: 8px; text-align: right;">‡¶Æ‡ßã‡¶ü ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï:</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${qContainers.length}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;

            printContent.innerHTML = html;
            sheetContainer.style.display = 'block'; 
            
            if (window.MathJax) {
                MathJax.typesetPromise([printContent]).then(() => {
                    window.print(); 
                    sheetContainer.style.display = 'none'; 
                }).catch((err) => {
                    console.error("Print MathJax rendering failed:", err);
                    alert("MathJax ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞‡¶ø‡¶Ç ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§");
                    window.print(); 
                    sheetContainer.style.display = 'none';
                });
            } else {
                 alert("MathJax ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞‡¶ø‡¶Ç ‡¶õ‡¶æ‡¶°‡¶º‡¶æ ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§");
                 window.print(); 
                 sheetContainer.style.display = 'none';
            }
        }
    }

    window.removeQuestion = function(buttonElement) {
        if (document.querySelectorAll('.question-container').length <= 1) { 
             alert("‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶•‡¶æ‡¶ï‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§");
             return;
        }

        const container = buttonElement.closest('.question-container');
        if (container) {
            container.remove();
            
            document.querySelectorAll('.question-container').forEach((cont, index) => {
                const newQIndex = index + 1;
                cont.querySelector('label').innerText = `‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ${newQIndex}:`;
                cont.setAttribute('data-q-index', newQIndex);
                const drawingBtn = cont.querySelector('.drawing-btn');
                if (drawingBtn) drawingBtn.setAttribute('onclick', `openDiagramTool(${newQIndex})`);
                
            });
            questionCounter = document.querySelectorAll('.question-container').length + 1; 
        }
    }
    
    window.previewQuestion = function(inputId) {
        const inputElement = document.getElementById(inputId);
        const previewDiv = document.getElementById(`preview_output_${inputId}`);
        const mathPreviewDiv = previewDiv.querySelector('.math-preview');
        
        const questionText = inputElement.value;
        
        if (questionText.trim() === '') {
            previewDiv.style.display = 'none';
            return;
        }

        mathPreviewDiv.innerText = questionText; 

        if (window.MathJax) {
            MathJax.typesetPromise([mathPreviewDiv]).then(() => {
                previewDiv.style.display = 'block';
            }).catch((err) => {
                console.error("MathJax rendering failed:", err);
                previewDiv.style.display = 'block';
                mathPreviewDiv.innerHTML = `<p style="color: var(--danger-color);">Error: ${err.message || 'MathJax ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞‡¶ø‡¶Ç ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§'}</p>`;
            });
        } else {
             previewDiv.style.display = 'block';
             mathPreviewDiv.innerHTML = `<p style="color: var(--danger-color);">MathJax ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡¶®‡¶ø‡•§</p>`;
        }
    }

    function generateExamLinkDisplay(examId, title, duration) {
        const link = `${getBaseUrl()}?id=${examId}`;

        document.getElementById('examLinkContainer').style.display = "block";
        document.getElementById('examLink').innerHTML = `<strong>üîó ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶¶‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï:</strong><br><a href="${link}" target="_blank">${link}</a>`;

        examID = examId; 
        examTitle = title;
        durationMinutes = duration;

        document.getElementById('saveOrUpdateExamBtn').style.display = 'none';
        document.getElementById('generateLinkBtn').style.display = 'none';
        document.getElementById('printExamBtn').style.display = 'block';

        alert("‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶®‡¶ø‡¶ö‡ßá ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï‡¶ü‡¶ø ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡•§");
    }

    window.shareLink = function(){
        const link=`${getBaseUrl()}?id=${examID}`;
        
        const message=`üîî MS Education ‡¶ï‡¶∞‡ßç‡¶§‡ßÉ‡¶ï ‡¶™‡¶∞‡¶ø‡¶ö‡¶æ‡¶≤‡¶ø‡¶§ ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ üîî\n\n‡¶¨‡¶ø‡¶∑‡ßü: ${examTitle}\n\n‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡ßü ‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßç‡¶∞‡¶π‡¶£ ‡¶ï‡¶∞‡¶§‡ßá, ‡¶®‡¶ø‡¶ö‡ßá ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§\n‡¶∏‡¶Æ‡¶Ø‡¶º‡¶∏‡ßÄ‡¶Æ‡¶æ: ${durationMinutes} ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü‡•§\n\n‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï: ${link}\n\n‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∂‡ßÅ‡¶≠‡¶ï‡¶æ‡¶Æ‡¶®‡¶æ ‡¶∞‡¶á‡¶≤! üôè`;
        
        if (navigator.share) {
            navigator.share({
                title: examTitle,
                text: message,
                url: link,
            })
            .catch((error) => {
                console.log('Error sharing', error);
                copyFallback(message, link); 
            });
        } else {
            copyFallback(message, link);
        }
    }

    function copyFallback(message, link) {
        navigator.clipboard.writeText(message).then(() => {
            alert(`‚úÖ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá!\n\n‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ‡¶ü‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßç‡¶≤‡¶ø‡¶™‡¶¨‡ßã‡¶∞‡ßç‡¶°‡ßá ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶è‡¶ñ‡¶® ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤‡¶ø ‡¶π‡ßã‡¶Ø‡¶º‡¶æ‡¶ü‡¶∏‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶¨‡¶æ ‡¶Æ‡ßá‡¶∏‡ßá‡¶û‡ßç‡¶ú‡¶æ‡¶∞‡ßá ‡¶™‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§`);
        }).catch(err => {
            alert("‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡ßü‡¶®‡¶ø‡•§ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï‡¶ü‡¶ø ‡¶®‡¶ø‡¶ú‡ßá ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®:\n" + link);
        });
    }

    async function loadSavedExams() {
        const listDiv = document.getElementById('savedExamsList');
        listDiv.innerHTML = '<p style="text-align: center; color: #666;"><i class="fas fa-spinner fa-spin"></i> ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>';

        if (!db) {
            listDiv.innerHTML = '<p style="text-align: center; color: var(--danger-color);">Firebase ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡•§</p>';
            return;
        }

        try {
            const snapshot = await db.collection("exams")
                                     .orderBy("createdAt", "desc")
                                     .limit(20)
                                     .get();

            let html = '';
            if (snapshot.empty) {
                html = '<p style="text-align: center; color: var(--danger-color); font-weight: 700;">‡¶è‡¶ñ‡¶®‡¶ì ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§</p>';
            } else {
                snapshot.forEach(doc => {
                    const exam = doc.data();
                    const examId = doc.id;
                    const link = `${getBaseUrl()}?id=${examId}`;
                    const date = exam.createdAt ? new Date(exam.createdAt.seconds * 1000).toLocaleDateString('bn-BD') : 'N/A';
                    
                    const resultStatus = exam.showResult ? 
                        '<span style="color: #4CAF50; font-weight: bold;">‚úì ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá</span>' : 
                        '<span style="color: #F44336; font-weight: bold;">‚úó ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶≤‡¶ï</span>';
                    
                    const activeStatus = exam.isActive ? 
                        '<span style="color: #4CAF50; font-weight: bold;">‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü</span>' : 
                        '<span style="color: #F44336; font-weight: bold;">‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡ßü</span>';
                    
                    html += `
                        <div class="exam-item">
                            <div class="exam-item-details">
                                <strong>${exam.title}</strong> (${exam.duration} ‡¶Æ‡¶ø. | ${exam.questions.length} ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®)
                                <p style="font-size: 11px; margin: 2px 0; color: #666;">
                                    ID: ${examId} | ‡¶§‡ßà‡¶∞‡¶ø: ${date}
                                </p>
                                <p style="font-size: 11px; margin: 2px 0;">
                                    ${resultStatus} | ${activeStatus}
                                </p>
                            </div>
                            <div class="exam-item-actions">
                                <button class="exam-btn exam-load-btn" onclick="loadExamForEdit('${examId}')">
                                    <i class="fas fa-edit"></i> ‡¶è‡¶°‡¶ø‡¶ü
                                </button>
                                <button class="exam-btn" onclick="copyExamLink('${link}', '${exam.title}', ${exam.duration})">
                                    <i class="fas fa-link"></i> ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï
                                </button>
                                <button class="exam-btn" onclick="toggleExamResultStatus('${examId}', ${exam.showResult || false})" style="background: ${exam.showResult ? '#F44336' : '#4CAF50'} !important;">
                                    <i class="fas fa-eye${exam.showResult ? '-slash' : ''}"></i> ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü
                                </button>
                                <button class="exam-btn" onclick="toggleExamActiveStatus('${examId}', ${exam.isActive !== false})" style="background: ${exam.isActive !== false ? '#F44336' : '#4CAF50'} !important;">
                                    <i class="fas fa-power-off"></i> ${exam.isActive !== false ? '‡¶¨‡¶®‡ßç‡¶ß' : '‡¶ö‡¶æ‡¶≤‡ßÅ'}
                                </button>
                                <button class="exam-delete-btn exam-btn" onclick="deleteExam('${examId}', '${exam.title}')">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            listDiv.innerHTML = html;
        } catch (e) {
            console.error("‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§:", e);
            listDiv.innerHTML = '<p style="text-align: center; color: var(--danger-color);">‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø‡•§</p>';
        }
    }

    // ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶ü‡¶ó‡¶≤
    window.toggleExamResultStatus = async function(examId, currentStatus) {
        const newStatus = !currentStatus;
        const confirmMessage = newStatus ? 
            "‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶¶‡ßá‡¶∞ ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶¶‡¶ø‡¶§‡ßá ‡¶ö‡¶æ‡¶®?" : 
            "‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶¶‡ßá‡¶∞ ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?";
        
        if (!confirm(confirmMessage)) return;
        
        try {
            if (!db) { throw new Error("Firebase DB not initialized."); }
            
            await db.collection("exams").doc(examId).update({
                showResult: newStatus,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            alert(newStatus ? 
                "‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶∞‡¶æ ‡¶è‡¶ñ‡¶® ‡¶§‡¶æ‡¶¶‡ßá‡¶∞ ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡•§" : 
                "‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶∞‡¶æ ‡¶Ü‡¶∞ ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá ‡¶®‡¶æ‡•§");
            
            loadSavedExams();
            
        } catch (e) {
            console.error("‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§:", e);
            alert(`‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡ßü‡¶®‡¶ø‡•§ ‡¶ï‡¶æ‡¶∞‡¶£: ${e.message}`);
        }
    }

    // ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü/‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‡¶ü‡¶ó‡¶≤
    window.toggleExamActiveStatus = async function(examId, currentStatus) {
        const newStatus = !currentStatus;
        const confirmMessage = newStatus ? 
            "‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶á ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶ü‡¶ø ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?" : 
            "‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶á ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶ü‡¶ø ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‡¶ï‡¶∞‡¶≤‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶∞‡¶æ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá ‡¶®‡¶æ‡•§";
        
        if (!confirm(confirmMessage)) return;
        
        try {
            if (!db) { throw new Error("Firebase DB not initialized."); }
            
            await db.collection("exams").doc(examId).update({
                isActive: newStatus,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            alert(newStatus ? 
                "‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶∞‡¶æ ‡¶è‡¶ñ‡¶® ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡•§" : 
                "‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶®‡¶§‡ßÅ‡¶® ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶∞‡¶æ ‡¶Ü‡¶∞ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá ‡¶®‡¶æ‡•§");
            
            loadSavedExams();
            
        } catch (e) {
            console.error("‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§:", e);
            alert(`‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡ßü‡¶®‡¶ø‡•§ ‡¶ï‡¶æ‡¶∞‡¶£: ${e.message}`);
        }
    }

    window.deleteExam = async function(examId, examTitle) {
        if (!confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§? "${examTitle}" ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶ü‡¶ø ‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§ ‡¶è‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶¶‡¶ø‡¶≤‡ßá ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶∞‡¶æ ‡¶Ü‡¶∞ ‡¶è‡¶á ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá ‡¶®‡¶æ, ‡¶§‡¶¨‡ßá ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤‡¶ó‡ßÅ‡¶≤‡¶ø (results) ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡•§ ‡¶è‡¶á ‡¶∏‡¶ø‡¶¶‡ßç‡¶ß‡¶æ‡¶®‡ßç‡¶§‡¶ü‡¶ø ‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡ßÄ‡¶Ø‡¶º‡•§`)) {
            return;
        }
        try {
            if (!db) { throw new Error("Firebase DB not initialized."); }
            
            await db.collection("exams").doc(examId).delete();
            
            alert(`"${examTitle}" ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`);
            loadSavedExams(); 
            
        } catch (e) {
            console.error("‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§:", e);
            alert(`‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡ßü‡¶®‡¶ø‡•§ ‡¶ï‡¶æ‡¶∞‡¶£: ${e.message}`);
        }
    }

    window.copyExamLink = function(link, title, duration) {
        examID = link.split('?id=')[1]; 
        examTitle = title;
        durationMinutes = duration;
        
        shareLink();
    }

    window.loadExamForEdit = async function(examId) {
        try {
            const docSnap = await db.collection("exams").doc(examId).get();

            if (!docSnap.exists) {
                alert("‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶ü‡¶ø ‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!");
                return;
            }

            const examData = docSnap.data();

            toggleTeacherPanel('newExam');
            currentEditExamID = null; 
            
            document.getElementById('examTitle').value = examData.title;
            document.getElementById('examDuration').value = examData.duration;
            document.getElementById('examIdDisplay').style.display = 'block';
            document.getElementById('examIdDisplay').innerText = `‡¶Ü‡¶™‡¶®‡¶ø "${examData.title}" ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶ü‡¶ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡¶õ‡ßá‡¶®‡•§ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶è‡¶ü‡¶ø ‡¶®‡¶§‡ßÅ‡¶® ID ‡¶∏‡¶π ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡ßá ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶¨‡ßá‡•§`;

            const formsDiv = document.getElementById('questionForms');
            formsDiv.innerHTML = '';
            questionCounter = 1;

            examData.questions.forEach(q => {
                addQuestion(q.question, q.options, q.answer.toString(), q.qImageURL || ''); 
            });
            
            document.getElementById('saveOrUpdateExamBtn').style.display = 'block';
            document.getElementById('generateLinkBtn').style.display = 'block'; 
            document.getElementById('examLinkContainer').style.display = 'none';
            document.getElementById('printExamBtn').style.display = 'none';

            alert(`"${examData.title}" ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶è‡¶°‡¶ø‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶∏‡ßá‡¶≠ ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶¨‡ßá‡•§`);

        } catch (e) {
            console.error("‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§:", e);
            alert(`‡¶è‡¶°‡¶ø‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡ßü‡¶®‡¶ø‡•§ ‡¶ï‡¶æ‡¶∞‡¶£: ${e.message}`);
        }
    }

    function createUniqueHash(name, mobile, examId, type = 'student') {
        if (type === 'student') {
            const cleanedMobile = mobile.replace(/[^0-9]/g, ''); 
            const key = `${name.toLowerCase().trim()}::${cleanedMobile}::${examId}`;
            return sha256(key);
        } else if (type === 'device') {
            const deviceKey = `${navigator.userAgent}::${examId}::${window.location.href.split('?')[0]}`;
            return sha256(deviceKey);
        }
        return Math.random().toString(36).substr(2, 9);
    }

    window.startExam = async function(){
        clearInterval(timerInterval); 
        
        studentName=document.getElementById('studentName').value.trim();
        studentGender=document.getElementById('studentGender').value; 
        studentClass=document.getElementById('studentClass').value;
        let studentMobileInput=document.getElementById('studentMobile').value.trim(); 

        if(!studentName){alert("‡¶õ‡¶æ‡¶§‡ßç‡¶∞/‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®!"); return;}
        if(!studentClass || studentClass === ""){alert("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®!"); return;}
        
        if(!studentMobileInput){alert("‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶®!"); return;}

        const cleanedMobile = studentMobileInput.replace(/[^0-9]/g, ''); 
        
        if (cleanedMobile.length !== 11) {
            alert("‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡¶ü‡¶ø ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡ßß‡ßß-‡¶°‡¶ø‡¶ú‡¶ø‡¶ü-‡¶è‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§");
            return;
        }
        
        const validPrefixes = ['013', '014', '015', '016', '017', '018', '019'];
        const prefix = cleanedMobile.substring(0, 3);

        if (!validPrefixes.includes(prefix)) {
            alert("‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡¶ü‡¶ø ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡¶ø ‡¶Ö‡¶™‡¶æ‡¶∞‡ßá‡¶ü‡¶∞‡ßá‡¶∞ ‡¶∏‡¶ø‡¶Æ‡ßá‡¶∞ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá (‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá 013, 014, 015, 016, 017, 018, ‡¶Ö‡¶•‡¶¨‡¶æ 019 ‡¶¶‡¶ø‡ßü‡ßá)‡•§");
            return;
        }
        
        studentMobile = cleanedMobile; 
        
        const uniqueCheckID_Student = createUniqueHash(studentName, studentMobile, examID, 'student');
        const uniqueCheckID_Device = createUniqueHash(studentName, studentMobile, examID, 'device');

        try {
            if (!db) { throw new Error("Firebase DB not initialized."); }

            // ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï
            const examDoc = await db.collection("exams").doc(examID).get();
            if (examDoc.exists) {
                const examData = examDoc.data();
                if (examData.isActive === false) {
                    alert("‡¶è‡¶á ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶ü‡¶ø ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶®‡ßá ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá‡•§ ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
                    return;
                }
            }

            // ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶ö‡ßá‡¶ï (allowRetakeExam ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ)
            if (!systemSettings.allowRetakeExam) {
                const checkDocStudent = await db.collection("exam_checks").doc(uniqueCheckID_Student).get();
                if (checkDocStudent.exists) {
                    document.getElementById('examFormContent').style.display = 'none';
                    document.getElementById('examCompletedMessage').style.display = 'block';
                    
                    document.getElementById('completedMessageText').innerHTML = `
                    <div class="duplicate-message-box">
                        <h2><i class="fas fa-exclamation-circle" style="color: var(--danger-color);"></i> ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®</h2>
                        <p class="duplicate-text-primary">
                            ‡¶Ü‡¶™‡¶®‡¶ø ‡¶á‡¶§‡¶ø ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶á ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶Ø‡¶º ‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßç‡¶∞‡¶π‡¶£ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§
                        </p>
                        <p class="duplicate-text-secondary">
                            ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ 
                        </p>
                    </div>
                    <div id="duplicateContactBlock2"></div>
                    `;
                    
                    injectContactLinks(); 
                    return;
                }
                
                const checkDocDevice = await db.collection("exam_checks").doc(uniqueCheckID_Device).get();
                if (checkDocDevice.exists) {
                    document.getElementById('examFormContent').style.display = 'none';
                    document.getElementById('examCompletedMessage').style.display = 'block';
                    
                    document.getElementById('completedMessageText').innerHTML = `
                    <div class="duplicate-message-box">
                        <h2><i class="fas fa-exclamation-triangle" style="color: var(--danger-color);"></i> ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®</h2>
                        <p class="duplicate-text-primary">
                            ‡¶è‡¶á ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶ü‡¶ø ‡¶á‡¶§‡ßã‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§
                        </p>
                        <p class="duplicate-text-secondary">
                            ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
                        </p>
                    </div>
                    <div id="duplicateContactBlock2"></div>
                    `;
                    
                    injectContactLinks(); 
                    return;
                }
            }

        } catch (e) {
            console.error("‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ö‡ßá‡¶ï ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§:", e);
            alert("‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§ ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡•§");
            return;
        }

        studentAnswers = questions.map(q => ({
            qText: q.question, 
            qOptions: q.options,
            correctAnswerIndex: q.answer,
            studentAnswerIndex: -1,
            qImageURL: q.qImageURL || ''
        }));
        
        studentStartPanel.style.display="none";
        quizPanel.style.display="block";
        
        score = 0; 
        currentQ = 0; 
        startTimer(durationMinutes);
        
        renderAllQuestions(); 
    }

    function startTimer(minutes){
        let time=minutes*60;
        const timerDisplay=document.getElementById('timerDisplay');
        clearInterval(timerInterval);

        timerInterval=setInterval(()=>{
        const min=String(Math.floor(time/60)).padStart(2,'0');
        const sec=String(time%60).padStart(2,'0');
        timerDisplay.innerText=`‡¶∏‡¶Æ‡¶Ø‡¶º: ${min}:${sec}`;

        if(time<=60){timerDisplay.style.color='var(--danger-color)';} 
        if(time<=0){
        clearInterval(timerInterval);
        submitAllAnswers(true);
        }
        time--;
        }, 1000);
    }
    
    function renderAllQuestions() {
        document.getElementById('examTitleDisplay').innerText=examTitle;
        const questionsContainer = document.getElementById('questionsContainer');
        questionsContainer.innerHTML = ''; 

        document.getElementById('quizTeacherInfo').innerHTML = `
            ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï:‚Äì <strong><span class="teacher-name-display">${CONTACT_LINKS.teacherName}</span></strong><br>
            <i class="fas fa-mosque" style="color: var(--primary-color);"></i> <span class="teacher-school-display">${CONTACT_LINKS.teacherSchool}</span>
        `;
        
        questions.forEach((q, index) => {
            let optionsHTML = '';
            
            q.options.forEach((optText, optIndex) => {
                const optionChar = banglaOptions[optIndex]; 
                
                optionsHTML += `
                    <label class="option-label">
                        <input type="radio" 
                               name="q_${index}" 
                               value="${optIndex}" 
                               onclick="updateStudentAnswer(${index}, ${optIndex})"
                               required>
                        <span class="option-custom-char">${optionChar}</span> 
                        <span class="option-text">${optText}</span>
                    </label>
                `;
            });

            const imageHTML = q.qImageURL 
                ? `<div class="question-image-container"><img src="${q.qImageURL}" alt="Question Diagram" class="question-diagram-img"></div>` 
                : '';

            const qHTML = `
                <div class="question-block">
                    ${imageHTML} 
                    <h4><span class="question-number">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ${index + 1}/${questions.length}:</span> <span class="question-text">${q.question}</span></h4>
                    <div class="options-group-all">
                        ${optionsHTML}
                    </div>
                </div>
            `;
            questionsContainer.innerHTML += qHTML;
        });

        if (window.MathJax) {
            MathJax.typesetPromise([questionsContainer]).catch((err) => {
                console.error("Quiz MathJax rendering failed:", err);
            });
        }
        
        document.getElementById('submitAllButton').disabled = false;
    }
    
    window.updateStudentAnswer = function(qIndex, optIndex) {
        if (qIndex < studentAnswers.length) {
            studentAnswers[qIndex].studentAnswerIndex = optIndex;
        }
    }

    window.submitAllAnswers = function(isAutoSubmit = false) {
        if (isAutoSubmit) {
            showResult();
            return;
        }

        const unansweredCount = studentAnswers.filter(a => a.studentAnswerIndex === -1).length;
        
        if (unansweredCount > 0) {
            if (!confirm(`‚ö†Ô∏è ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ: ‡¶Ü‡¶™‡¶®‡¶ø ${unansweredCount} ‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶è‡¶ñ‡¶®‡¶ì ‡¶¶‡ßá‡¶®‡¶®‡¶ø‡•§ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶®‡¶æ ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶™‡¶æ‡¶¨‡ßá‡¶® ‡¶®‡¶æ‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶§‡¶¨‡ßÅ‡¶ì ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?`)) {
                return;
            }
        } else {
             if (!confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶ï‡¶¨‡¶æ‡¶∞ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶≤‡ßá ‡¶Ü‡¶∞ ‡¶´‡¶ø‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ‡•§")) {
                return;
            }
        }

        showResult();
    }

    async function showResult(){
        clearInterval(timerInterval);
        quizPanel.style.display="none";
        resultPanel.style.display="block";

        score = 0;
        studentAnswers.forEach(answer => {
            if (answer.studentAnswerIndex !== -1 && answer.studentAnswerIndex === answer.correctAnswerIndex) {
                score++;
            }
        });
        
        const totalQuestions = questions.length;
        const percentage = totalQuestions > 0 ? Math.round((score / totalQuestions) * 100) : 0;
        
        let gradeInfo = gradingSystem.find(g => percentage >= g.minPercent) || gradingSystem[gradingSystem.length - 1];
        
        // ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶ö‡ßá‡¶ï
        let showResultToStudent = systemSettings.showResultToStudent;
        
        try {
            if (db) {
                const examDoc = await db.collection("exams").doc(examID).get();
                if (examDoc.exists) {
                    const examData = examDoc.data();
                    // ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶≤‡ßá‡¶≠‡ßá‡¶≤‡ßá ‡¶ì‡¶≠‡¶æ‡¶∞‡¶∞‡¶æ‡¶á‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá
                    if (examData.showResult !== undefined) {
                        showResultToStudent = examData.showResult;
                    }
                }
            }
        } catch (e) {
            console.error("Exam settings check failed:", e);
        }
        
        if (showResultToStudent) {
            // ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá
            const resultTitleDisplay = document.getElementById('resultTitleDisplay');
            resultTitleDisplay.innerHTML = `
                ${studentName.split(' ')[0]}, ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá!<br>
                <small style="font-size: 16px; color: var(--success-color);">
                    ‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§ ‡¶ó‡ßç‡¶∞‡ßá‡¶°: <strong>${gradeInfo.grade}</strong> (${gradeInfo.remark})
                </small>
            `; 
            
            document.getElementById('resultHiddenMessage').style.display = 'block';
            document.getElementById('resultHiddenMessage').innerHTML = `
                <div style="text-align: center; margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 10px; border-left: 5px solid var(--primary-color);">
                    <div style="margin-top: 15px; display: inline-block; padding: 10px 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <p style="margin: 5px 0; font-size: 16px;">
                            <i class="fas fa-chart-line" style="color: var(--primary-color);"></i> 
                            ‡¶∏‡ßç‡¶ï‡ßã‡¶∞: <strong>${score}/${totalQuestions}</strong>
                        </p>
                        <p style="margin: 5px 0; font-size: 16px;">
                            <i class="fas fa-percentage" style="color: var(--success-color);"></i> 
                            ‡¶∂‡¶§‡¶ï‡¶∞‡¶æ: <strong>${percentage}%</strong>
                        </p>
                        <p style="margin: 5px 0; font-size: 16px;">
                            <i class="fas fa-graduation-cap" style="color: #9C27B0;"></i> 
                            ‡¶ó‡ßç‡¶∞‡ßá‡¶°: <strong>${gradeInfo.grade}</strong>
                        </p>
                    </div>
                </div>
            `;
        } else {
            // ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá ‡¶®‡¶æ
            const resultTitleDisplay = document.getElementById('resultTitleDisplay');
            resultTitleDisplay.innerHTML = `
                ${studentName.split(' ')[0]}, ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá!<br>
                <small style="font-size: 16px; color: green;">
                    ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶Ø‡¶º ‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßç‡¶∞‡¶π‡¶£ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶üéâ
                </small>
            `; 
            
            document.getElementById('resultHiddenMessage').style.display = 'block';
            document.getElementById('resultHiddenMessage').innerHTML = `
                <div style="text-align: center; margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #ffcdd2 0%, #f8bbd0 100%); border-radius: 10px; border-left: 5px solid var(--danger-color);">
                    <h3 style="color: var(--danger-color);">
                        <i class="fas fa-lock"></i> ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶≤‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá
                    </h3>
                    <p style="font-size: 16px; color: #333; margin-top: 10px;">
                        ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ‡¶§‡ßá ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂ ‡¶ï‡¶∞‡¶¨‡ßá‡¶®‡•§
                    </p>
                    <p style="font-size: 14px; color: #666; margin-top: 5px;">
                        ‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶‡¶æ‡¶®‡ßç‡¶§‡ßá,<br>
                        <strong>${CONTACT_LINKS.teacherName}</strong>
                    </p>
                </div>
            `;
        }

        const uniqueCheckID_Student = createUniqueHash(studentName, studentMobile, examID, 'student');
        const uniqueCheckID_Device = createUniqueHash(studentName, studentMobile, examID, 'device');

        injectContactLinks(); 

        const resultData = {
            examID: examID,
            examTitle: examTitle,
            studentName: studentName,
            studentGender: studentGender, 
            studentClass: studentClass,
            studentMobile: studentMobile,
            uniqueCheckID: uniqueCheckID_Student, 
            score: `${score}/${totalQuestions}`, 
            percentage: percentage,
            grade: gradeInfo.grade,
            gpa: gradeInfo.gpa,
            answers: studentAnswers, 
            totalQuestions: totalQuestions, 
            totalCorrect: score,             
            timestamp: firebase.firestore.FieldValue.serverTimestamp() 
        };
        
        try {
            if (!db) { throw new Error("Firebase DB not initialized."); }
            
            await db.collection("results").add(resultData);
            
            // allowRetakeExam ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ exam_checks ‡¶è ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ
            if (!systemSettings.allowRetakeExam) {
                await db.collection("exam_checks").doc(uniqueCheckID_Student).set({ 
                    examID: examID,
                    studentName: studentName,
                    type: 'student',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                await db.collection("exam_checks").doc(uniqueCheckID_Device).set({ 
                    examID: examID,
                    studentName: studentName,
                    type: 'device',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            }

            // ‡¶Ö‡¶ü‡ßã ‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá
            if (systemSettings.autoShareResult && showResultToStudent) {
                setTimeout(() => {
                    shareResult(resultData);
                }, 2000);
            }

        } catch (e) {
            console.error("‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§:", e);
        }
    }

    window.updateResultTable = async function(){
        const table=document.getElementById('resultTable');
        table.innerHTML=`<tr><th>‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ</th><th>‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</th><th>‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ</th><th>‡¶∏‡ßç‡¶ï‡ßã‡¶∞</th><th>‡¶ó‡ßç‡¶∞‡ßá‡¶°</th><th>‡¶∏‡¶Æ‡¶Ø‡¶º</th><th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th></tr>`; 
        
        if (!db) return;
        
        try {
            const snapshot = await db.collection("results")
                                     .orderBy("timestamp", "desc")
                                     .limit(50)
                                     .get();

            snapshot.forEach(docSnap => {
                const res = docSnap.data();
                const resultId = docSnap.id; 
                const date = res.timestamp ? new Date(res.timestamp.seconds * 1000).toLocaleString('bn-BD', { hour: '2-digit', minute: '2-digit', year: 'numeric', month: 'short', day: 'numeric' }) : 'N/A';
                
                const row=table.insertRow();
                row.insertCell(0).innerText=res.examTitle;
                
                row.insertCell(1).innerHTML=`
                    ${res.studentName} (${res.studentGender ? res.studentGender.slice(0, 1) : 'N/A'})
                    <br><a href="tel:${res.studentMobile}" class="mobile-link" style="font-size: 11px;">${res.studentMobile}</a>
                `; 
                
                const studentClassText = res.studentClass || '';
                row.insertCell(2).innerText = studentClassText.replace('Class ', 'C'); 
                
                row.insertCell(3).innerText=res.score;
                row.insertCell(4).innerText=res.grade || '-';
                row.insertCell(5).innerText=date;
                
                const actionCell = row.insertCell(6);
                actionCell.classList.add('action-buttons');

                const detailBtn = document.createElement('button');
                detailBtn.innerText = '‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§';
                detailBtn.classList.add('detail-btn');
                detailBtn.innerHTML = '<i class="fas fa-eye"></i>';
                detailBtn.onclick = () => showDetailedResult(res);
                actionCell.appendChild(detailBtn);
                
                const certificateBtn = document.createElement('button');
                certificateBtn.innerText = '‡¶∏‡¶æ‡¶∞‡ßç‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶ü';
                certificateBtn.classList.add('detail-btn');
                certificateBtn.style.background = '#9C27B0 !important';
                certificateBtn.innerHTML = '<i class="fas fa-award"></i>';
                certificateBtn.onclick = () => generateCertificate(res);
                actionCell.appendChild(certificateBtn);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.innerText = '‡¶°‡¶ø‡¶≤‡¶ø‡¶ü';
                deleteBtn.classList.add('result-delete-btn');
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                deleteBtn.onclick = () => deleteSingleResult(resultId, res.studentName, res.examTitle, res.uniqueCheckID, res.examID); 
                actionCell.appendChild(deleteBtn);
                
            });
        } catch (e) {
            console.error("‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§:", e);
            alert("‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§ Firebase Rules ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        }
    }

    window.downloadExamResults = async function(examId, examTitle) {
        try {
            const snapshot = await db.collection("results")
                .where("examID", "==", examId)
                .orderBy("timestamp", "desc")
                .get();

            if (snapshot.empty) {
                alert("‡¶è‡¶á ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§");
                return;
            }

            const results = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                results.push({
                    '‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ': data.examTitle,
                    '‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ': data.studentName,
                    '‡¶≤‡¶ø‡¶ô‡ßç‡¶ó': data.studentGender || '',
                    '‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ': data.studentClass || '',
                    '‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤': data.studentMobile,
                    '‡¶∏‡ßç‡¶ï‡ßã‡¶∞': data.score,
                    '‡¶∂‡¶§‡¶ï‡¶∞‡¶æ': data.percentage || '',
                    '‡¶ó‡ßç‡¶∞‡ßá‡¶°': data.grade || '',
                    '‡¶ú‡¶ø‡¶™‡¶ø‡¶è': data.gpa || '',
                    '‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ': data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleDateString('bn-BD') : ''
                });
            });

            const worksheet = XLSX.utils.json_to_sheet(results);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "‡¶´‡¶≤‡¶æ‡¶´‡¶≤");

            const fileName = `results_${examId}_${new Date().getTime()}.xlsx`;
            XLSX.writeFile(workbook, fileName);
            
            alert(`"${examTitle}" ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ${results.length} ‡¶ü‡¶ø ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ Excel ‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`);
            
        } catch (e) {
            console.error("‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§:", e);
            alert("‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§");
        }
    }

    // ‡¶ü‡ßÅ‡¶≤‡¶∏ ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    window.backupData = async function() {
        if (!confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶°‡ßá‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶ü‡¶ø JSON ‡¶´‡¶æ‡¶á‡¶≤ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá‡•§")) return;
        
        try {
            const examsSnapshot = await db.collection("exams").get();
            const resultsSnapshot = await db.collection("results").get();
            const settingsSnapshot = await db.collection("system_settings").get();
            
            const backupData = {
                exams: [],
                results: [],
                settings: [],
                backupDate: new Date().toISOString(),
                appVersion: "MS Education Pro v7.5"
            };
            
            examsSnapshot.forEach(doc => {
                backupData.exams.push({
                    id: doc.id,
                    data: doc.data()
                });
            });
            
            resultsSnapshot.forEach(doc => {
                backupData.results.push({
                    id: doc.id,
                    data: doc.data()
                });
            });
            
            settingsSnapshot.forEach(doc => {
                backupData.settings.push({
                    id: doc.id,
                    data: doc.data()
                });
            });
            
            const blob = new Blob([JSON.stringify(backupData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ms_education_backup_${new Date().getTime()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶∏‡¶´‡¶≤! ${backupData.exams.length} ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ, ${backupData.results.length} ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
            
        } catch (e) {
            console.error("‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§:", e);
            alert("‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡ßü‡¶®‡¶ø‡•§");
        }
    }
    
    window.restoreData = async function() {
        if (!confirm("‚ö†Ô∏è ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡ßá‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) return;
        
        const fileInput = document.getElementById('restoreFile');
        if (!fileInput.files.length) {
            alert("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø JSON ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
            return;
        }
        
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = async function(e) {
            try {
                const backupData = JSON.parse(e.target.result);
                
                if (!backupData.exams || !backupData.results) {
                    alert("‡¶≠‡ßÅ‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡•§");
                    return;
                }
                
                // ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡ßá‡¶∂‡¶®
                const confirmMobile = prompt("‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶®:");
                if (confirmMobile !== CONTACT_LINKS.mobile) {
                    alert("‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≠‡ßÅ‡¶≤‡•§ ‡¶Ö‡¶™‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤‡•§");
                    return;
                }
                
                // ‡¶è‡¶ï‡ßç‡¶∏‡¶æ‡¶Æ‡¶∏ ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞
                let examCount = 0;
                for (const exam of backupData.exams) {
                    await db.collection("exams").doc(exam.id).set(exam.data);
                    examCount++;
                }
                
                // ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü‡¶∏ ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞
                let resultCount = 0;
                for (const result of backupData.results) {
                    await db.collection("results").doc(result.id).set(result.data);
                    resultCount++;
                }
                
                // ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞
                if (backupData.settings) {
                    for (const setting of backupData.settings) {
                        await db.collection("system_settings").doc(setting.id).set(setting.data);
                    }
                }
                
                alert(`‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶∏‡¶´‡¶≤! ${examCount} ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ, ${resultCount} ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
                loadSavedExams();
                updateResultTable();
                
            } catch (e) {
                console.error("‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§:", e);
                alert("‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡ßü‡¶®‡¶ø‡•§ ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶≠‡ßÅ‡¶≤ ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§");
            }
        };
        
        reader.readAsText(file);
    }
    
    window.clearAllResults = async function() {
        if (!confirm("‚ö†Ô∏è ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) {
            return;
        }
        
        const confirmMobile = prompt("‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶®:");
        if (confirmMobile !== CONTACT_LINKS.mobile) {
            alert("‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≠‡ßÅ‡¶≤‡•§ ‡¶Ö‡¶™‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤‡•§");
            return;
        }
        
        try {
            const resultsSnapshot = await db.collection("results").get();
            const batch = db.batch();
            
            resultsSnapshot.forEach(doc => {
                batch.delete(doc.ref);
            });
            
            await batch.commit();
            alert("‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            updateResultTable();
            
        } catch (e) {
            console.error("‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§:", e);
            alert("‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
        }
    }
    
    window.clearAllExams = async function() {
        if (!confirm("‚ö†Ô∏è ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶§‡¶æ‡¶¶‡ßá‡¶∞ ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) {
            return;
        }
        
        const confirmMobile = prompt("‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶®:");
        if (confirmMobile !== CONTACT_LINKS.mobile) {
            alert("‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≠‡ßÅ‡¶≤‡•§ ‡¶Ö‡¶™‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤‡•§");
            return;
        }
        
        try {
            // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®
            const resultsSnapshot = await db.collection("results").get();
            const resultsBatch = db.batch();
            resultsSnapshot.forEach(doc => {
                resultsBatch.delete(doc.ref);
            });
            await resultsBatch.commit();
            
            // ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®
            const examsSnapshot = await db.collection("exams").get();
            const examsBatch = db.batch();
            examsSnapshot.forEach(doc => {
                examsBatch.delete(doc.ref);
            });
            await examsBatch.commit();
            
            // ‡¶ö‡ßá‡¶ï ‡¶°‡ßá‡¶ü‡¶æ‡¶ì ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®
            const checksSnapshot = await db.collection("exam_checks").get();
            const checksBatch = db.batch();
            checksSnapshot.forEach(doc => {
                checksBatch.delete(doc.ref);
            });
            await checksBatch.commit();
            
            alert("‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            loadSavedExams();
            updateResultTable();
            
        } catch (e) {
            console.error("‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§:", e);
            alert("‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
        }
    }
    
    window.resetSystem = async function() {
        if (!confirm("‚ö†Ô∏è ‡¶ö‡¶∞‡¶Æ ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶π‡¶¨‡ßá! ‡¶∏‡¶¨ ‡¶°‡ßá‡¶ü‡¶æ ‡¶ö‡¶ø‡¶∞‡¶§‡¶∞‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) {
            return;
        }
        
        const confirmMobile = prompt("‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶®:");
        if (confirmMobile !== CONTACT_LINKS.mobile) {
            alert("‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≠‡ßÅ‡¶≤‡•§ ‡¶Ö‡¶™‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤‡•§");
            return;
        }
        
        const doubleConfirm = prompt("'‡¶π‡ßç‡¶Ø‡¶æ‡¶Å, ‡¶Ü‡¶Æ‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§' ‡¶ü‡¶æ‡¶á‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®:");
        if (doubleConfirm !== '‡¶π‡ßç‡¶Ø‡¶æ‡¶Å, ‡¶Ü‡¶Æ‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§') {
            alert("‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡ßá‡¶∂‡¶® ‡¶≠‡ßÅ‡¶≤‡•§ ‡¶Ö‡¶™‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤‡•§");
            return;
        }
        
        try {
            // ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®
            const collections = ['exams', 'results', 'exam_checks', 'system_settings'];
            
            for (const collection of collections) {
                const snapshot = await db.collection(collection).get();
                const batch = db.batch();
                
                snapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
            }
            
            alert("‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶∞‡ßÇ‡¶™‡ßá ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‡¶∏‡¶¨ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
            loadSavedExams();
            updateResultTable();
            
        } catch (e) {
            console.error("‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§:", e);
            alert("‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡ßü‡¶®‡¶ø‡•§");
        }
    }
    
    window.bulkQuestionUpload = function() {
        const modal = document.getElementById('bulkUploadModal');
        modal.style.display = 'block';
    }
    
    window.closeBulkUploadModal = function() {
        document.getElementById('bulkUploadModal').style.display = 'none';
    }
    
    window.processBulkQuestions = function() {
        const textarea = document.getElementById('bulkQuestionsText');
        const questionsText = textarea.value.trim();
        
        if (!questionsText) {
            alert("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§");
            return;
        }
        
        const lines = questionsText.split('\n');
        let currentQuestion = '';
        let currentOptions = [];
        let questionCount = 0;
        
        for (const line of lines) {
            const trimmedLine = line.trim();
            
            if (!trimmedLine) continue;
            
            // ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∂‡¶®‡¶æ‡¶ï‡ßç‡¶§‡¶ï‡¶∞‡¶£ (‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶®‡¶Ç ‡¶¶‡¶ø‡ßü‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶≤‡ßá)
            if (trimmedLine.match(/^\d+[\.\)]\s*/)) {
                // ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
                if (currentQuestion && currentOptions.length >= 4) {
                    addQuestion(currentQuestion, currentOptions, '0', '');
                    questionCount++;
                }
                
                // ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®
                currentQuestion = trimmedLine.replace(/^\d+[\.\)]\s*/, '');
                currentOptions = [];
            }
            // ‡¶Ö‡¶™‡¶∂‡¶® ‡¶∂‡¶®‡¶æ‡¶ï‡ßç‡¶§‡¶ï‡¶∞‡¶£ (‡¶ï, ‡¶ñ, ‡¶ó, ‡¶ò ‡¶¶‡¶ø‡ßü‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶≤‡ßá)
            else if (trimmedLine.match(/^[‡¶ï‡¶ñ‡¶ó‡¶ò][\.\)]\s*/)) {
                const optionText = trimmedLine.replace(/^[‡¶ï‡¶ñ‡¶ó‡¶ò][\.\)]\s*/, '');
                currentOptions.push(optionText);
            }
            // ‡¶Ö‡¶™‡¶∂‡¶® ‡¶∂‡¶®‡¶æ‡¶ï‡ßç‡¶§‡¶ï‡¶∞‡¶£ (a, b, c, d ‡¶¶‡¶ø‡ßü‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶≤‡ßá)
            else if (trimmedLine.match(/^[abcdABCD][\.\)]\s*/)) {
                const optionText = trimmedLine.replace(/^[abcdABCD][\.\)]\s*/, '');
                currentOptions.push(optionText);
            }
            // ‡¶Ö‡¶™‡¶∂‡¶® ‡¶∂‡¶®‡¶æ‡¶ï‡ßç‡¶§‡¶ï‡¶∞‡¶£ (1, 2, 3, 4 ‡¶¶‡¶ø‡ßü‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶≤‡ßá)
            else if (trimmedLine.match(/^[1234][\.\)]\s*/)) {
                const optionText = trimmedLine.replace(/^[1234][\.\)]\s*/, '');
                currentOptions.push(optionText);
            }
        }
        
        // ‡¶∂‡ßá‡¶∑ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ü‡¶ø ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
        if (currentQuestion && currentOptions.length >= 4) {
            addQuestion(currentQuestion, currentOptions, '0', '');
            questionCount++;
        }
        
        if (questionCount > 0) {
            alert(`${questionCount} ‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!`);
            closeBulkUploadModal();
        } else {
            alert("‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∂‡¶®‡¶æ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        }
    }
    
    window.downloadTemplate = function() {
        const template = `1. ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶∞‡¶æ‡¶ú‡¶ß‡¶æ‡¶®‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶ï‡ßÄ?
‡¶ï. ‡¶¢‡¶æ‡¶ï‡¶æ
‡¶ñ. ‡¶ö‡¶ü‡ßç‡¶ü‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ
‡¶ó. ‡¶∞‡¶æ‡¶ú‡¶∂‡¶æ‡¶π‡ßÄ
‡¶ò. ‡¶ñ‡ßÅ‡¶≤‡¶®‡¶æ

2. ‡ß®+‡ß® ‡¶ï‡¶§?
‡¶ï. ‡ß©
‡¶ñ. ‡ß™
‡¶ó. ‡ß´
‡¶ò. ‡ß¨

3. ‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø ‡¶ï‡ßã‡¶® ‡¶¶‡¶ø‡¶ï‡ßá ‡¶â‡¶†‡ßá?
‡¶ï. ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨
‡¶ñ. ‡¶™‡¶∂‡ßç‡¶ö‡¶ø‡¶Æ
‡¶ó. ‡¶â‡¶§‡ßç‡¶§‡¶∞
‡¶ò. ‡¶¶‡¶ï‡ßç‡¶∑‡¶ø‡¶£

‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶®‡¶æ:
1. ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶®‡¶Ç ‡¶¶‡¶ø‡ßü‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶® (1., 2., ‡¶á‡¶§‡ßç‡¶Ø‡¶æ‡¶¶‡¶ø)
2. ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶Ö‡¶™‡¶∂‡¶® ‡¶®‡¶§‡ßÅ‡¶® ‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶ï., ‡¶ñ., ‡¶ó., ‡¶ò.)
3. ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶´‡¶æ‡¶Å‡¶ï‡¶æ ‡¶≤‡¶æ‡¶á‡¶® ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®`;
        
        const blob = new Blob([template], {type: 'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'question_template.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    window.generateCertificate = function(result) {
        const scoreParts = result.score.split('/');
        const correct = parseInt(scoreParts[0]);
        const total = parseInt(scoreParts[1]);
        const percentage = result.percentage || Math.round((correct / total) * 100);
        
        const certificateHTML = `
            <div id="certificateContainer" style="width: 800px; height: 600px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 40px; text-align: center; border: 20px solid gold; position: relative;">
                <div style="position: absolute; top: 20px; left: 20px; right: 20px; bottom: 20px; border: 2px solid var(--primary-color); padding: 30px;">
                    <h1 style="color: var(--primary-color); font-size: 42px; margin-bottom: 10px;">CERTIFICATE OF ACHIEVEMENT</h1>
                    <h2 style="color: #333; font-size: 32px; margin-bottom: 30px;">‡¶™‡ßç‡¶∞‡¶Æ‡¶æ‡¶£‡¶™‡¶§‡ßç‡¶∞</h2>
                    
                    <p style="font-size: 24px; margin-bottom: 20px;">‡¶è‡¶á ‡¶Æ‡¶∞‡ßç‡¶Æ‡ßá ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶Ø‡ßá</p>
                    
                    <div style="border-bottom: 3px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 20px; display: inline-block;">
                        <h3 style="font-size: 36px; color: var(--danger-color); margin: 0;">${result.studentName}</h3>
                    </div>
                    
                    <p style="font-size: 20px; margin-bottom: 10px;">
                        <strong>${result.examTitle}</strong> ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶Ø‡¶º ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßç‡¶∞‡¶π‡¶£ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§
                    </p>
                    
                    <div style="display: flex; justify-content: center; gap: 40px; margin: 30px 0;">
                        <div style="text-align: center;">
                            <div style="font-size: 28px; color: var(--primary-color); font-weight: bold;">${result.score}</div>
                            <div style="font-size: 16px;">‡¶∏‡ßç‡¶ï‡ßã‡¶∞</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 28px; color: var(--success-color); font-weight: bold;">${percentage}%</div>
                            <div style="font-size: 16px;">‡¶∂‡¶§‡¶ï‡¶∞‡¶æ</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 28px; color: #9C27B0; font-weight: bold;">${result.grade || 'A'}</div>
                            <div style="font-size: 16px;">‡¶ó‡ßç‡¶∞‡ßá‡¶°</div>
                        </div>
                    </div>
                    
                    <p style="font-size: 18px; margin-bottom: 30px;">
                        ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${new Date().toLocaleDateString('bn-BD', { year: 'numeric', month: 'long', day: 'numeric' })}
                    </p>
                    
                    <div style="display: flex; justify-content: space-between; margin-top: 48px;">
                        <div style="text-align: center;">
                            <div style="border-top: 2px solid #333; padding-top: 0px; width: 200px;">
                                <strong>${CONTACT_LINKS.teacherName}</strong><br>
                                MS EDUCATION TEACHING SENTER 
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <div style="border-top: 2px solid #333; padding-top: 0px; width: 200px;">
                                <strong>MS EDUCATION</strong><br>
                                ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ
                            </div>
                        </div>
                    </div>
                    
                    <div style="position: absolute; bottom: 20px; right: 20px;">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d0/QR_code_for_mobile_English_Wikipedia.svg/220px-QR_code_for_mobile_English_Wikipedia.svg.png" 
                             style="width: 80px; height: 80px; opacity: 0.3;">
                    </div>
                </div>
            </div>
            
            <button onclick="printCertificate()" style="margin-top: 20px; background: var(--primary-color); color: white;">
                <i class="fas fa-print"></i> ‡¶∏‡¶æ‡¶∞‡ßç‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶ü ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
            </button>
        `;
        
        document.getElementById('certificateModalContent').innerHTML = certificateHTML;
        document.getElementById('certificateModal').style.display = 'block';
    }

    window.printCertificate = function() {
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
            <head>
                <title>Certificate - ${studentName}</title>
                <style>
                    body { margin: 0; padding: 0; font-family: 'Arial', sans-serif; }
                    @media print {
                        @page { size: landscape; margin: 0; }
                    }
                </style>
            </head>
            <body>
                ${document.getElementById('certificateContainer').outerHTML}
                <script>
                    window.onload = function() {
                        window.print();
                        setTimeout(function() {
                            window.close();
                        }, 1000);
                    }
                <\/script>
            </body>
            </html>
        `);
        printWindow.document.close();
    }

    window.deleteSingleResult = async function(resultId, studentName, examTitle, uniqueCheckID_Student, examId) {
        if (!confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§? ‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ${studentName} ‡¶è‡¶∞ "${examTitle}" ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤‡¶ü‡¶ø ‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§ ‡¶è‡¶á ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶¶‡¶ø‡¶≤‡ßá ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶ü‡¶ø ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶Ø‡¶º ‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßç‡¶∞‡¶π‡¶£‡ßá‡¶∞ ‡¶∏‡ßÅ‡¶Ø‡ßã‡¶ó ‡¶™‡¶æ‡¶¨‡ßá‡•§`)) {
            return;
        }
        
        try {
            if (!db) { throw new Error("Firebase DB not initialized."); }
            
            await db.collection("results").doc(resultId).delete();
            
            if (uniqueCheckID_Student) {
                await db.collection("exam_checks").doc(uniqueCheckID_Student).delete();
            }

            alert(`${studentName} ‡¶è‡¶∞ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶ü‡¶ø ‡¶è‡¶ñ‡¶® ‡¶ö‡¶æ‡¶á‡¶≤‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡•§`);
            updateResultTable(); 
            
        } catch (e) {
            console.error("‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§:", e);
            alert(`‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡ßü‡¶®‡¶ø‡•§ ‡¶ï‡¶æ‡¶∞‡¶£: ${e.message}`);
        }
    }

    window.showDetailedResult = function(res) {
        const modal = document.getElementById('detailModal');
        const modalContentDiv = document.getElementById('modalContent');
        const totalQuestions = res.totalQuestions || res.answers.length;
        const scoreParts = res.score ? res.score.split('/') : ['0', totalQuestions];
        const totalCorrect = parseInt(scoreParts[0]);
        const totalIncorrect = totalQuestions - totalCorrect;
        const percentage = res.percentage || Math.round((totalCorrect / totalQuestions) * 100);
        const date = res.timestamp ? new Date(res.timestamp.seconds * 1000).toLocaleString('bn-BD') : 'N/A';
        
        let gradeInfo = gradingSystem.find(g => percentage >= g.minPercent) || gradingSystem[gradingSystem.length - 1];

        let html = `
        <div id="resultSheet">
            <div class="sheet-header">
                <h3 style="margin-bottom: 5px; color: var(--primary-color); font-size: 26px; border-bottom: 3px solid var(--secondary-color); padding-bottom: 5px;">
                    <i class="fas fa-graduation-cap"></i> MS EDUCATION - ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü
                </h3>

                <p style="font-size: 15px; font-weight: 700; color: var(--danger-color); margin-bottom: 5px;">
                    <i class="fas fa-user-tie"></i> ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï:‚Äì <span class="teacher-name-display">${CONTACT_LINKS.teacherName}</span>
                </p>
                <p style="font-size: 14px; color: #666; margin-top: 0;">
                    <i class="fas fa-mosque"></i> <span class="teacher-school-display">${CONTACT_LINKS.teacherSchool}</span>
                </p>
                <hr style="margin: 10px 0;">

                <div style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0;">
                    <div>
                        <h4 style="margin: 0; color: var(--primary-color); font-size: 22px; font-weight: 800;">
                            ${res.studentName.split(' ')[0]}
                        </h4>
                        <p style="margin: 5px 0 0 0; color: #666;">
                            ${res.studentClass || ''} | ${res.studentGender || ''}
                        </p>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 18px; font-weight: bold; color: var(--primary-color);">
                            ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ: ${res.examTitle}
                        </div>
                        <div style="font-size: 14px; color: #666;">
                            ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${date}
                        </div>
                    </div>
                </div>
                
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; margin: 20px 0; text-align: center;">
                    <div style="display: flex; justify-content: space-around;">
                        <div>
                            <div style="font-size: 32px; font-weight: bold;">${totalCorrect}/${totalQuestions}</div>
                            <div>‡¶∏‡ßç‡¶ï‡ßã‡¶∞</div>
                        </div>
                        <div>
                            <div style="font-size: 32px; font-weight: bold;">${percentage}%</div>
                            <div>‡¶∂‡¶§‡¶ï‡¶∞‡¶æ</div>
                        </div>
                        <div>
                            <div style="font-size: 32px; font-weight: bold;">${gradeInfo.grade}</div>
                            <div>‡¶ó‡ßç‡¶∞‡ßá‡¶°</div>
                        </div>
                        <div>
                            <div style="font-size: 32px; font-weight: bold;">${gradeInfo.gpa}</div>
                            <div>‡¶ú‡¶ø‡¶™‡¶ø‡¶è</div>
                        </div>
                    </div>
                    <p style="margin-top: 10px; font-size: 16px; font-style: italic;">
                        ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø: ${gradeInfo.remark}
                    </p>
                </div>
            </div>
            
            <h4><i class="fas fa-clipboard-check"></i> ‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶™‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</h4>
            <hr>
        `;

        res.answers.forEach((q, index) => {
            const studentAnsIndex = q.studentAnswerIndex;
            const correctAnsIndex = q.correctAnswerIndex;
            const isCorrect = studentAnsIndex === correctAnsIndex;
            
            let borderStyle = isCorrect ? 'solid var(--success-color)' : (studentAnsIndex === -1 ? 'solid #aaa' : 'solid var(--danger-color)');

            const detailImageHTML = q.qImageURL 
                ? `<div style="text-align: center; margin-bottom: 10px;"><img src="${q.qImageURL}" alt="Question Diagram" style="max-width: 100%; border: 1px solid #ddd; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);"></div>` 
                : '';

            html += `<div class="detail-item" style="border-left: 5px ${borderStyle}; padding: 15px; margin-bottom: 15px; background: #fafafa; border-radius: 5px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong style="font-size: 16px; color: var(--primary-color);">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ${index + 1}:</strong>
                    <span style="padding: 3px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; background: ${isCorrect ? '#4CAF50' : studentAnsIndex === -1 ? '#9E9E9E' : '#F44336'}; color: white;">
                        ${isCorrect ? '‡¶∏‡¶†‡¶ø‡¶ï' : studentAnsIndex === -1 ? '‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶π‡ßÄ‡¶®' : '‡¶≠‡ßÅ‡¶≤'}
                    </span>
                </div>
                ${detailImageHTML} 
                <div class="q-text"><span class="math-text">${q.qText}</span></div>`; 
            
            q.qOptions.forEach((opt, optIndex) => {
                let style = 'font-size: 15px; margin: 5px 0 0 15px; padding: 5px; border-radius: 3px;';
                let label = '';
                const optionChar = banglaOptions[optIndex]; 
                
                if (optIndex === correctAnsIndex) {
                    style += ' background: #E8F5E9; border-left: 3px solid #4CAF50;'; 
                    label = ' (‡¶∏‡¶†‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞)';
                }
                if (optIndex === studentAnsIndex && !isCorrect) {
                    style += ' background: #FFEBEE; border-left: 3px solid #F44336; text-decoration: line-through;';
                    label = ' (‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶≠‡ßÅ‡¶≤ ‡¶â‡¶§‡ßç‡¶§‡¶∞)';
                } else if (optIndex === studentAnsIndex && isCorrect) {
                    style += ' background: #E8F5E9; border-left: 3px solid #4CAF50; font-weight: bold;';
                }
                
                html += `<div style="${style}"><span class="math-text-option">
                    <strong>${optionChar}.</strong> ${opt}${label}
                </span></div>`; 
            });

            if (studentAnsIndex === -1) {
                html += `<div style="margin-top: 10px; padding: 8px; background: #FFF3E0; border-left: 3px solid #FF9800; border-radius: 3px;">
                    <i class="fas fa-exclamation-circle"></i> ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶ü‡¶ø ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶Ø‡¶º‡¶®‡¶ø‡•§
                </div>`;
            }
            
            html += `</div>`;
        });
        
        html += `
            <div class="sheet-footer" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee;">
                <div style="text-align: center; color: #666; font-size: 14px;">
                    <p>MS EDUCATION: ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ</p>
                    <p>‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü‡ßá‡¶°: ${new Date().toLocaleString('bn-BD')}</p>
                </div>
            </div>
        </div>
        `;
        
        modalContentDiv.innerHTML = html;
        modal.style.display = "block";
        
        const pdfPrintBtn = document.getElementById('pdfPrintBtn');
        pdfPrintBtn.onclick = () => {
             if (window.MathJax) {
                MathJax.typesetPromise([modalContentDiv]).then(() => {
                    window.print();
                }).catch((err) => {
                    console.error("Modal Print MathJax rendering failed:", err);
                    alert("MathJax ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞‡¶ø‡¶Ç ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§");
                    window.print();
                });
             } else {
                 window.print();
             }
        };

        if (window.MathJax) {
            MathJax.typesetPromise([modalContentDiv]).catch((err) => {
                console.error("Result Detail MathJax rendering failed:", err);
            });
        }
        
        const shareBtn = document.getElementById('shareResultBtn');
        shareBtn.onclick = () => shareResult(res);
    }

    window.shareResult = function(res) {
        const totalQuestions = res.totalQuestions || res.answers.length;
        const scoreParts = res.score ? res.score.split('/') : ['0', totalQuestions];
        const totalCorrect = parseInt(scoreParts[0]);
        const percentage = res.percentage || Math.round((totalCorrect / totalQuestions) * 100);
        
        const message = 
            `*üéâ ‡¶Ö‡¶≠‡¶ø‡¶®‡¶®‡ßç‡¶¶‡¶®! ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ üéâ*\n\n` +
            `*‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï:* ${CONTACT_LINKS.teacherName} (${CONTACT_LINKS.teacherSchool})\n` +
            `*‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ:* ${res.studentName}\n` +
            `*‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ:* ${res.studentClass || 'N/A'}\n` +
            `*‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ:* ${res.examTitle}\n\n` +
            `*‡¶Æ‡ßã‡¶ü ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®:* ${totalQuestions} ‡¶ü‡¶ø\n` +
            `*‡¶∏‡¶†‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞:* ${totalCorrect} ‡¶ü‡¶ø\n` +
            `*‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§ ‡¶∏‡ßç‡¶ï‡ßã‡¶∞:* ${res.score}\n` +
            `*‡¶∂‡¶§‡¶ï‡¶∞‡¶æ:* ${percentage}%\n` +
            `*‡¶ó‡ßç‡¶∞‡ßá‡¶°:* ${res.grade || '-'}\n\n` +
            `_‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó: ${CONTACT_LINKS.teacherName}, ${CONTACT_LINKS.mobile}_\n\n` +
            `#MS_EDUCATION`;

        if (navigator.share) {
            navigator.share({
                title: '‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤',
                text: message,
            }).catch(error => {
                navigator.clipboard.writeText(message).then(() => {
                    alert('‚úÖ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶ï‡¶™‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶è‡¶ñ‡¶® ‡¶Æ‡ßá‡¶∏‡ßá‡¶û‡ßç‡¶ú‡¶æ‡¶∞/‡¶π‡ßã‡¶Ø‡¶º‡¶æ‡¶ü‡¶∏‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá ‡¶™‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                }).catch(err => {
                    alert('‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶¨‡¶æ ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§');
                });
            });
        } else {
            navigator.clipboard.writeText(message).then(() => {
                alert('‚úÖ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶ï‡¶™‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶è‡¶ñ‡¶® ‡¶Æ‡ßá‡¶∏‡ßá‡¶û‡ßç‡¶ú‡¶æ‡¶∞/‡¶π‡ßã‡¶Ø‡¶º‡¶æ‡¶ü‡¶∏‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá ‡¶™‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
            }).catch(err => {
                alert('‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶® ‡¶è‡¶á ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶õ‡ßá ‡¶®‡¶æ‡•§ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
            });
        }
    }

    window.closeModal = function() {
        document.getElementById('detailModal').style.display = "none";
        document.getElementById('bulkUploadModal').style.display = "none";
        document.getElementById('certificateModal').style.display = "none";
    }

    window.onpopstate = function(event) {
        const modal = document.getElementById('detailModal');
        const diagramModal = document.getElementById('diagramModal'); 
        const quiz = document.getElementById('quiz');
        const studentStart = document.getElementById('studentStart');
        const bulkModal = document.getElementById('bulkUploadModal');
        const certificateModal = document.getElementById('certificateModal');
        const settingsMenu = document.querySelector('#teacher .settings-menu');

        if (modal.style.display === 'block') {
            modal.style.display = 'none';
            history.pushState(null, null, window.location.href); 
            return; 
        }
        
        if (diagramModal.style.display === 'block') { 
             closeDiagramModal();
             history.pushState(null, null, window.location.href);
             return;
        }
        
        if (bulkModal.style.display === 'block') {
            bulkModal.style.display = 'none';
            history.pushState(null, null, window.location.href);
            return;
        }
        
        if (certificateModal.style.display === 'block') {
            certificateModal.style.display = 'none';
            history.pushState(null, null, window.location.href);
            return;
        }
        
        if (settingsMenu && settingsMenu.style.display === 'block') {
            settingsMenu.style.display = 'none';
            history.pushState(null, null, window.location.href);
            return;
        }
        
        if (quiz.style.display === 'block') {
            if (confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ‡¶ú‡¶Æ‡¶æ ‡¶π‡¶¨‡ßá ‡¶®‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ ‡¶™‡¶æ‡¶§‡¶æ‡¶Ø‡¶º ‡¶´‡ßá‡¶∞‡¶§ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá‡•§")) {
                clearInterval(timerInterval);
                window.location.href = getBaseUrl();
            } else {
                history.pushState(null, null, window.location.href);
            }
            return;
        } 
        
        if (studentStart.style.display === 'block') {
            window.location.href = getBaseUrl();
            return;
        }
        
        if (teacherPanel.style.display === 'block' && currentTeacherView !== 'newExam') {
            toggleTeacherPanel('newExam');
            history.pushState(null, null, window.location.href);
            return;
        }
    };

    window.onload=function(){
        const appContainer = document.getElementById('app');
        teacherPanel = document.getElementById('teacher');
        studentStartPanel = document.getElementById('studentStart');
        quizPanel = document.getElementById('quiz');
        resultPanel = document.getElementById('result');
        errorMessageDiv = document.getElementById('default-message'); 
        resultListPanel = document.getElementById('resultPanel');
        savedExamsPanel = document.getElementById('savedExamsPanel');
        newExamPanel = document.getElementById('newExamPanel');

        errorMessageDiv.style.display="none"; 
        appContainer.style.display="none"; 

        document.getElementById('splashScreen').style.display="flex";

        setTimeout(async () => {
            document.getElementById('splashScreen').style.display="none";
            appContainer.style.display="block";
            
            if (typeof firebase === 'undefined' || !db) {
                document.getElementById('default-message').style.display="block";
                appContainer.style.display="none"; 
                document.getElementById('default-message').innerHTML = `
                    <h2><i class="fas fa-exclamation-triangle"></i> ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø (Firebase Error)</h2>
                    <p style="font-size: 18px; color: var(--danger-color);">‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§</p>
                    <hr style="margin-top: 30px;">
                    <p style="font-size: 15px; color: #666; text-align: center;">**‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï‡¶¶‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø:** ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                `;
                return;
            }

            injectContactLinks(); 
            loadSettings(); // ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
            
            const params=new URLSearchParams(window.location.search);
            
            if(params.has('id')){
                const id=params.get('id');
                examID = id;
                
                const uniqueCheckID_Device = createUniqueHash('', '', examID, 'device');
                let deviceCheckExists = false;
                
                try {
                    const docSnapDevice = await db.collection("exam_checks").doc(uniqueCheckID_Device).get();
                    deviceCheckExists = docSnapDevice.exists;
                } catch (e) {
                    console.error("Device check failed:", e);
                }
                
                if (deviceCheckExists && !systemSettings.allowRetakeExam) {
                    document.getElementById('default-message').style.display="block"; 
                    appContainer.style.display="none";
                    
                    document.getElementById('default-message').innerHTML = `
                        <h2><i class="fas fa-exclamation-triangle" style="color: var(--danger-color);"></i> ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®!</h2>
                        <div class="duplicate-message-box large-box">
                            <p class="duplicate-text-primary" style="font-size: 22px;">
                                ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶è‡¶á ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏‡¶ü‡¶ø ‡¶á‡¶§‡ßã‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶ï‡¶¨‡¶æ‡¶∞ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ö‡¶ø‡¶π‡ßç‡¶®‡¶ø‡¶§‡•§
                            </p>
                            <p class="duplicate-text-secondary" style="font-size: 18px; margin-top: 10px;">
                                ‡¶è‡¶ï‡¶¨‡¶æ‡¶∞ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∞‡ßã‡¶ß‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡ßü ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ø‡¶¶‡¶ø ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶®‡¶æ ‡¶¶‡¶ø‡ßü‡ßá ‡¶•‡¶æ‡¶ï‡ßá‡¶®, ‡¶§‡¶¨‡ßá ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
                            </p>
                        </div>
                        <div id="duplicateContactBlock"></div>
                    `;
                    injectContactLinks();
                    return;
                }

                try {
                    const docSnap = await db.collection("exams").doc(id).get();
                    
                    if(docSnap.exists){
                        const examData = docSnap.data();
                        
                        // ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï
                        if (examData.isActive === false) {
                            document.getElementById('default-message').style.display="block"; 
                            appContainer.style.display="none";
                            document.getElementById('default-message').innerHTML = `
                                <h2><i class="fas fa-exclamation-circle"></i> ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡ßü!</h2>
                                <p style="font-size: 18px; color: var(--danger-color);">
                                    ‡¶è‡¶á ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶ü‡¶ø ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶®‡ßá ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá‡•§
                                </p>
                                <p style="font-size: 16px; color: #666;">
                                    ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
                                </p>
                                <div id="duplicateContactBlock"></div>
                            `;
                            injectContactLinks();
                            return;
                        }
                        
                        examTitle=examData.title;
                        questions=examData.questions;
                        durationMinutes=examData.duration;
                        
                        document.getElementById('studentExamTitleDisplay').innerHTML = `<i class="fas fa-file-alt"></i> ${examTitle}`;
                        document.getElementById('durationDisplay').innerText = durationMinutes;

                        studentStartPanel.style.display="block";
                        
                    } else {
                        document.getElementById('default-message').style.display="block"; 
                        appContainer.style.display="none";
                        document.getElementById('default-message').innerHTML = `
                            <h2><i class="fas fa-exclamation-circle"></i> ‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§! ‡¶è‡¶á ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶ü‡¶ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</h2>
                            <p style="font-size: 18px; color: var(--danger-color);">‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ø‡ßá ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®, ‡¶∏‡ßá‡¶ü‡¶ø ‡¶π‡ßü‡¶§‡ßã ‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶ ‡¶â‡¶§‡ßç‡¶§‡ßÄ‡¶∞‡ßç‡¶£ ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶≠‡ßÅ‡¶≤‡•§</p>
                            <hr>
                            <p style="font-size: 15px; color: #666; text-align: center;">**‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶¶‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø:** ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï‡¶ü‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                        `;
                    }
                } catch (e) {
                    console.error("‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§:", e);
                    document.getElementById('default-message').style.display="block";
                    appContainer.style.display="none";
                }
            } 
            else if (params.has('teacher') || !params.toString()) {
                 teacherPanel.style.display="block"; 
                 toggleTeacherPanel('newExam');
                 if (!params.has('teacher')) {
                    history.pushState(null, null, window.location.href.split('?')[0] + '?teacher');
                 }
            }
            else {
                document.getElementById('default-message').style.display="block";
                appContainer.style.display="none";
            }

        }, 5500); 
    }
</script>
<style>
:root {
    --primary-color: #0d47a1; 
    --secondary-color: #ffb300; 
    --success-color: #00c853; 
    --danger-color: #d32f2f; 
    --info-color: #00bcd4; 
    --bg-gradient: linear-gradient(145deg, #1e3c72, #2a5298); 
    --card-bg: #ffffff;
    --text-color: #212121;
}
body { 
    font-family: 'Baloo Da 2', sans-serif; 
    background: var(--bg-gradient); 
    margin:0; 
    padding:0; 
    display:flex; 
    justify-content:center; 
    min-height:100vh; 
    align-items:flex-start; 
    color: var(--text-color);
}
#app { 
    background: var(--card-bg); 
    padding:20px; 
    border-radius:20px; 
    box-shadow:0 15px 40px rgba(0,0,0,0.6); 
    width:100%; 
    max-width:750px; 
    margin-top:20px; 
    margin-bottom: 20px;
    border: 5px solid var(--secondary-color); 
    display: none; 
    transition: all 0.5s ease;
    position: relative;
}
h2 { 
    text-align:center; 
    color: var(--primary-color); 
    margin-bottom:15px; 
    border-bottom: 3px solid var(--secondary-color); 
    padding-bottom: 10px; 
    font-size: 26px; 
    font-weight: 800;
}

/* ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶Ü‡¶á‡¶ï‡¶® ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ - ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá */
#teacher .settings-icon {
    position: absolute;
    top: 20px;
    right: 20px;
    background: var(--primary-color);
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1000;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    transition: all 0.3s;
}
#teacher .settings-icon:hover {
    background: var(--secondary-color);
    transform: rotate(30deg);
    box-shadow: 0 3px 15px rgba(0,0,0,0.4);
}

/* ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶Æ‡ßá‡¶®‡ßÅ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ - ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá */
#teacher .settings-menu {
    position: absolute;
    top: 70px;
    right: 20px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    padding: 20px;
    width: 300px;
    z-index: 1001;
    display: none;
    border: 2px solid var(--primary-color);
}
#teacher .settings-menu h3 {
    margin-top: 0;
    color: var(--primary-color);
    border-bottom: 2px solid var(--secondary-color);
    padding-bottom: 10px;
    margin-bottom: 15px;
}
.setting-item {
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px dashed #eee;
}
.setting-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}
.setting-label span {
    font-weight: 600;
    color: #333;
}
.setting-description {
    font-size: 12px;
    color: #666;
    margin-top: 3px;
}

/* ‡¶ü‡¶ó‡¶≤ ‡¶∏‡ßÅ‡¶á‡¶ö ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}
.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}
.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 24px;
}
.slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}
input:checked + .slider {
    background-color: var(--success-color);
}
input:checked + .slider:before {
    transform: translateX(26px);
}

.input-group{margin:10px 0;} 
input, select, textarea{
    width:100%; 
    padding:12px; 
    border-radius:8px; 
    border:1px solid #ccc; 
    font-size:16px; 
    box-sizing: border-box;
    transition: all 0.3s;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}
input:focus, select:focus, textarea:focus { 
    border-color: var(--primary-color); 
    box-shadow: 0 0 10px rgba(13, 71, 161, 0.5); 
}
.options-group {
    display: flex;
    gap: 5px;
}
.options-group .small-input {
    padding: 8px;
    font-size: 14px;
}
.correct-select-group {
    display: flex;
    align-items: center;
    gap: 10px;
}
.correct-select-group label {
    font-weight: 700;
    font-size: 15px;
}
.correct-select-group .small-select {
    width: 30%;
    padding: 8px;
    font-size: 14px;
}
button{
    width:100%; 
    padding:12px; 
    border:none; 
    font-size:16px; 
    border-radius:8px; 
    cursor:pointer; 
    margin-top:10px; 
    transition: all 0.3s ease; 
    box-shadow:0 4px 10px rgba(0,0,0,0.2); 
    font-weight:bold;
    display: flex;
    align-items: center;
    justify-content: center;
}
button:hover{transform: translateY(-2px); box-shadow:0 6px 15px rgba(0,0,0,0.3);}
button i { margin-right: 8px; font-size: 16px; } 

#teacher button:not(.share-btn):not(.utility-btn):not(.detail-btn):not(.exam-btn):not(.tools-btn){background:var(--success-color); color:white;}
.share-btn { 
    background: var(--info-color); 
    color: white; 
    margin-bottom: 5px;
}
.teacher-nav-btn {
    padding: 10px 10px !important;
    font-size: 14px !important;
    margin-top: 0;
}
.teacher-nav-btn.active-nav {
    background: var(--secondary-color) !important;
    color: var(--text-color) !important;
    border: 2px solid var(--primary-color);
    box-shadow: 0 0 10px var(--secondary-color);
}
.utility-btn {
    background: #607d8b !important;
    color: white !important;
    padding: 5px 10px !important;
    width: auto !important;
    margin: 0 !important;
    font-size: 12px !important;
    box-shadow: none !important;
    transition: all 0.3s;
}
.utility-btn:hover {
    transform: none;
    background: #455a64 !important;
}
.remove-btn {
    background: var(--danger-color) !important;
}
.preview-btn {
    background: var(--info-color) !important;
    margin-right: 5px !important;
}
.drawing-btn { 
    background: #5e35b1 !important;
    margin-right: 5px !important;
}
.file-upload-btn {
    background: #009688 !important;
    margin-right: 5px !important;
}
.question-header-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}
.question-header-bar label {
    font-weight: 700;
}
.header-actions {
    display: flex;
    gap: 5px;
}
.preview-output {
    margin: 10px 0;
    padding: 10px;
    border: 1px dashed #ccc;
    border-radius: 5px;
    background: #f7f7f7;
}
.math-preview {
    overflow-x: auto; 
    padding: 5px 0;
}
.image-preview { 
    margin: 10px 0;
    padding: 5px;
    text-align: center;
}
.image-preview img {
    max-width: 100%;
    height: auto;
    border-radius: 5px;
}
.exam-btn {
    background: #4CAF50; 
    color: white;
    width: auto !important;
    padding: 5px 8px !important; 
    margin: 3px;
    font-size: 12px !important; 
}
.exam-btn i {
    margin: 0 !important;
}
.exam-item-actions {
    display: flex;
    gap: 3px;
    margin-left: 5px;
}
.exam-item-actions button {
    margin: 0 !important;
    padding: 5px 8px !important;
    font-size: 12px !important;
    width: auto !important;
}
.exam-delete-btn {
    background: var(--danger-color) !important;
}
.exam-load-btn {
    background: var(--secondary-color) !important;
    color: var(--text-color) !important;
}
.tools-btn {
    background: #FF9800 !important;
    color: white !important;
    margin: 5px !important;
    padding: 10px 15px !important;
    font-size: 14px !important;
    width: 100% !important;
    border-radius: 8px !important;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2) !important;
}
.tools-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3) !important;
}
.tool-item {
    border: 2px solid #ddd;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 10px;
    background: #f9f9f9;
}
.tool-item.danger {
    border-color: var(--danger-color);
    background: #ffebee;
}
.table-container {
    max-height: 350px; 
    overflow-y: auto;
}
th, td{padding:8px; text-align:center; font-size: 12px;} 

td .action-buttons button { 
    width: auto !important; 
    padding: 4px 6px !important; 
    margin: 2px !important; 
    font-size: 11px !important; 
}

#splashScreen {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: var(--bg-gradient); 
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}
.splash-circle {
    width: 250px; height: 250px; 
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.05);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position: relative;
    box-shadow: 0 0 50px rgba(255, 255, 255, 0.3);
    animation: rotateGlow 5s ease-out forwards; 
}
.splash-title {
    font-size: 55px; font-weight: 800; margin-bottom: 5px; opacity: 0;
    color: #fff; text-shadow: 0 0 15px var(--secondary-color), 0 0 20px #fff;
    animation: fadeInScale 2.5s 0.5s forwards;
    letter-spacing: 2px;
}
.splash-subtitle {
    font-size: 20px; opacity: 0; color: #fff;
    animation: fadeIn 2.5s 1s forwards;
    margin-top: 5px;
}
.splash-teacher {
    position: absolute;
    bottom: -150px; 
    font-size: 20px; 
    font-weight: 700;
    color: #fff;
    text-align: center;
    line-height: 1.5;
    padding: 10px 20px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 15px;
    opacity: 0;
    animation: fadeIn 2s 3.5s forwards; 
    border: 3px solid var(--secondary-color);
}
.teacher-glow {
    background: linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
    background-size: 300% 300%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: rgbMove 3s infinite alternate;
    display: inline-block;
}

@keyframes fadeInScale {
    0% { transform: scale(0.5); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}
@keyframes fadeIn {
    0% { opacity: 0; }
    100% { opacity: 1; }
}
@keyframes rotateGlow {
    0% { transform: rotate(0deg); box-shadow: 0 0 50px var(--secondary-color); }
    50% { box-shadow: 0 0 60px var(--info-color); transform: rotate(720deg); }
    70% { transform: rotate(0deg); } 
    100% { transform: rotate(0deg); box-shadow: 0 0 50px var(--secondary-color); } 
}
@keyframes rgbMove { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }

.teacher-info {
    text-align: center; margin-bottom: 15px; font-size: 16px; color: #424242; font-weight: 700; line-height: 1.5;
}
.teacher-info strong, .contact-info-list strong {
    font-size: 20px; 
    color: var(--danger-color) !important; 
    display: block; 
    margin-bottom: 5px;
}

#examCompletedMessage {
    background: none; 
    padding: 0;
    border-radius: 0;
    border: none;
    text-align: center;
    margin-top: 25px;
    box-shadow: none;
    color: white; 
}
#examCompletedMessage h2 {
    color: #fff; 
    border-bottom: 3px solid var(--secondary-color);
}
.duplicate-message-box {
    background: #ffecb3; 
    padding: 20px;
    border-radius: 15px;
    border: 3px solid var(--danger-color); 
    text-align: center;
    margin-top: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
}
.duplicate-message-box.large-box {
    margin-bottom: 20px;
}
.duplicate-text-primary {
    font-size: 20px; 
    color: #8B0000; 
    font-weight: 800; 
    margin-top: 0; 
    text-shadow: 1px 1px 2px #ffc107; 
}
.duplicate-text-secondary {
    font-size: 18px; 
    color: var(--primary-color); 
    font-weight: 700; 
    margin-top: 10px;
}
.duplicate-contact-header {
    font-size: 18px; 
    color: #fff; 
    font-weight: 700; 
    margin-top: 20px; 
    border-top: 1px dashed #fff; 
    padding-top: 15px;
    text-align: center;
}
.contact-info-list a {
    font-size: 16px;
    font-weight: bold;
}
.contact-mobile-link-dark { 
    color: var(--text-color) !important; 
    text-decoration: underline;
} 

.detail-item {
    border-left: 5px solid; 
    background: #fff; 
    padding: 10px; 
    border-radius: 5px; 
    margin-bottom: 8px; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

#quiz {
    width: calc(100% + 40px); 
    margin: -20px -20px -20px -20px; 
    height: calc(100vh - 40px); 
    overflow-y: auto; 
    padding: 0;
    box-sizing: border-box;
}
.quiz-header {
    position: sticky; 
    top: 0; 
    z-index: 10; 
    background-color: var(--card-bg); 
    padding: 8px 15px; 
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    border-bottom: 3px solid var(--secondary-color);
}
.quiz-header h2 {
    border-bottom: none !important;
    padding-bottom: 0 !important;
    margin: 5px 0 5px 0; 
    font-size: 22px; 
}
.quiz-header .teacher-info {
    margin-top: 0;
    margin-bottom: 5px; 
    font-size: 13px; 
}
.quiz-header .teacher-info strong {
    font-size: 16px; 
}
.quiz-header .timer {
    margin-top: 3px;
    font-size: 1.1em; 
    font-weight: bold;
    text-align: center;
}
.quiz-header p {
    font-size: 12px !important; 
}

.moving-title {
    font-size: 2em; 
    color: var(--primary-color); 
    display: inline-block; 
    font-weight: 900;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    width: 100%;
    text-align: center;
    overflow: hidden;
    white-space: nowrap; 
    animation: moveTitle 5s infinite alternate ease-in-out; 
}
@keyframes moveTitle {
    0% { transform: translateX(-5%); }
    100% { transform: translateX(5%); } 
}

.quiz-content {
    padding: 20px; 
}

.question-block {
    border: 1px solid #ddd;
    padding: 18px;
    margin-bottom: 18px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.question-block h4 {
    font-size: 18px; 
    font-weight: 700;
    color: var(--primary-color);
    margin-top: 0;
    margin-bottom: 15px;
    line-height: 1.5;
    display: flex; 
}
.question-block h4 .question-number {
    margin-right: 5px;
    white-space: nowrap;
}
.question-block h4 .question-text {
    flex-grow: 1;
}

.question-image-container {
    text-align: center;
    margin-bottom: 15px;
    padding: 10px;
    border: 1px dashed #ccc;
    border-radius: 5px;
    background: #fafafa;
}
.question-diagram-img {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 0 auto;
}

.option-text .MathJax { 
    vertical-align: middle !important; 
    font-size: 1.0em !important; 
}
.question-text .MathJax, .math-text .MathJax, .math-text-option .MathJax {
    font-size: 1.1em !important; 
}

.options-group-all {
    margin-top: 10px;
}
.option-label {
    display: flex; 
    align-items: center;
    padding: 12px; 
    margin: 8px 0; 
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s;
    border: 1px solid #ccc; 
    font-size: 16px; 
    font-weight: 600;
}
.option-label:hover {
    background-color: #e3f2fd; 
    border-color: var(--primary-color);
}
.option-label input[type="radio"] {
    width: 0;
    height: 0;
    opacity: 0;
    position: absolute;
}
.option-custom-char {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    width: 28px;
    height: 28px;
    border: 2px solid #ccc;
    border-radius: 50%;
    margin-right: 12px;
    font-weight: 800;
    font-size: 14px;
    color: var(--text-color);
    background-color: #f5f5f5;
    transition: all 0.2s;
}
.option-label input[type="radio"]:checked + .option-custom-char {
    background-color: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
    box-shadow: 0 0 5px var(--primary-color);
}
.option-text {
    flex-grow: 1; 
}

.modal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.8);
}
.modal-content {
    background-color: #fefefe;
    margin: 5% auto; 
    padding: 20px;
    border: 1px solid #888;
    width: 90%; 
    max-width: 600px;
    border-radius: 15px;
    position: relative;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
}
.modal .close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    position: absolute; 
    top: 10px;
    right: 15px;
}
.modal-content button {
    margin-top: 10px;
    margin-bottom: 5px;
}

#diagramModal .modal-content {
    margin: 2% auto;
    max-width: 95%;
    width: 90%;
}
#diagramModal h3 {
    text-align: center;
    color: #5e35b1;
    border-bottom: 2px solid #5e35b1;
    padding-bottom: 5px;
    margin-bottom: 10px;
}
.canvas-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    padding: 10px 0;
    gap: 10px;
}
.canvas-controls label {
    font-weight: 600;
    font-size: 14px;
    margin-right: 5px;
}
.canvas-controls input[type="color"], .canvas-controls input[type="range"] {
    width: 50px;
    padding: 0;
    height: 30px;
    border: none;
    cursor: pointer;
}
.canvas-controls .control-group {
    display: flex;
    align-items: center;
    margin-bottom: 0px; 
}
.control-group-row {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    width: 100%;
}
.control-group-row button {
    flex: 1;
    min-width: 80px;
    font-size: 11px !important;
    padding: 6px 5px !important;
    margin-top: 0 !important;
}

#canvas-container {
    border: 2px dashed #ccc;
    margin: 10px 0;
    text-align: center;
    width: 100%;
    overflow: hidden;
}
#diagramCanvas {
    border: 1px solid #ddd;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    touch-action: none;
}
#smartDrawingBtn {
    background: #ff9800 !important;
    color: white !important;
    width: 100%;
    margin-top: 5px;
}
#smartDrawingBtn.active-smart {
    background: #4caf50 !important;
    font-weight: bold;
}
.text-input-group {
    display: flex;
    gap: 5px;
    margin-bottom: 5px;
}
.text-input-group input {
    padding: 8px;
    font-size: 14px;
    flex: 1;
}
.text-input-group button {
    width: auto !important;
    padding: 8px 10px !important;
    margin-top: 0 !important;
}

@media print {
    body {
        margin: 0;
        padding: 0;
        background: none;
        font-size: 12pt;
        color: #000;
    }
    #app, #diagramModal, #default-message, #detailModal, .modal-content .close, #bulkUploadModal, #certificateModal, .settings-icon, .settings-menu {
        display: none !important;
    }
    
    #resultSheet, #printQuestionSheet, #certificateContainer {
        display: block !important;
        width: 210mm;
        min-height: 297mm;
        padding: 10mm;
        margin: 0;
        box-sizing: border-box;
        overflow: hidden; 
        position: static;
    }
    
    .sheet-header, .sheet-info, .sheet-footer, .detail-item, .print-question-item, .print-answer-key {
        break-inside: avoid;
        page-break-inside: avoid;
        break-before: auto;
    }
    
    #printQuestionSheet {
        display: block !important;
        width: 210mm; 
        min-height: 297mm;
        padding: 10mm;
        margin: 0;
        box-sizing: border-box;
    }
    
    .print-question-item {
        break-inside: avoid;
        margin-bottom: 15px;
        border: 1px dashed #eee; 
        padding: 10px;
        border-radius: 5px;
    }
    
    .question-diagram-img, .detail-item, .print-answer-key, .print-header-section, .print-answer-key h3 {
         -webkit-print-color-adjust: exact !important;
         color-adjust: exact !important;
    }
    .print-answer-key {
        border: 1px solid #d32f2f;
        padding: 10px;
        border-radius: 5px;
        margin-top: 25px;
    }
    .print-answer-key h3 {
        color: var(--danger-color) !important;
    }
    
    .MathJax {
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
    }
    
    #certificateContainer {
        transform: scale(0.9);
        transform-origin: top left;
    }
}
</style>
</head>
<body>

<div id="printQuestionSheet" style="display: none;">
    <div id="printQuestionContent"></div>
</div>

<div id="splashScreen">
    <div class="splash-circle">
        <div class="splash-title">MS EDUCATION</div>
        <div class="splash-subtitle"><b style="font-size: 25px; color: Red;">
            ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶™‡¶∞‡¶ø‡¶ï‡ßç‡¶∑‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ</b><span class="teacher-name-display"></span> 
            <span class="teacher-school-display"></span>
        </div>
    </div>
    <div class="splash-teacher">
        <i class="fas fa-school" style="color: var(--secondary-color);"></i> ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ
    </div>
</div>

<div id="app">

<div id="teacher" style="display:none;">
    <!-- ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶Ü‡¶á‡¶ï‡¶® ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá -->
    <div class="settings-icon" onclick="toggleSettingsMenu()">
        <i class="fas fa-cog"></i>
    </div>

    <!-- ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶Æ‡ßá‡¶®‡ßÅ ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá -->
    <div class="settings-menu">
        <h3><i class="fas fa-cogs"></i> ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h3>
        
        <div class="setting-item">
            <div class="setting-label">
                <span>‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶∞‡¶æ ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá</span>
                <label class="switch">
                    <input type="checkbox" id="showResultSwitch">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-description">
                ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶∞‡¶æ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∂‡ßá‡¶∑‡ßá ‡¶§‡¶æ‡¶¶‡ßá‡¶∞ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá ‡¶ï‡¶ø‡¶®‡¶æ
            </div>
        </div>
        
        <div class="setting-item">
            <div class="setting-label">
                <span>‡¶Ö‡¶ü‡ßã ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶∂‡ßá‡ßü‡¶æ‡¶∞</span>
                <label class="switch">
                    <input type="checkbox" id="autoShareSwitch">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-description">
                ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∂‡ßá‡¶∑‡ßá ‡¶∏‡ßç‡¶¨‡ßü‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡ßü‡¶≠‡¶æ‡¶¨‡ßá ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶Ö‡¶™‡¶∂‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá
            </div>
        </div>
        
        <div class="setting-item">
            <div class="setting-label">
                <span>‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü</span>
                <label class="switch">
                    <input type="checkbox" id="examActiveSwitch">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-description">
                ‡¶®‡¶§‡ßÅ‡¶® ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‡¶•‡¶æ‡¶ï‡¶¨‡ßá ‡¶ï‡¶ø‡¶®‡¶æ
            </div>
        </div>
        
        <div class="setting-item">
            <div class="setting-label">
                <span>‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡ßü ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø</span>
                <label class="switch">
                    <input type="checkbox" id="allowRetakeSwitch">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-description">
                ‡¶è‡¶ï‡¶á ‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá ‡¶ï‡¶ø‡¶®‡¶æ
            </div>
        </div>
        
        <div class="setting-item">
            <div class="setting-label">
                <span>‡¶∏‡¶†‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã</span>
                <label class="switch">
                    <input type="checkbox" id="showAnswerSwitch">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-description">
                ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá ‡¶ï‡¶ø‡¶®‡¶æ
            </div>
        </div>
        
        <div class="setting-item">
            <div class="setting-label">
                <span>‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï</span>
                <label class="switch">
                    <input type="checkbox" id="requirePhotoSwitch">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-description">
                ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶¶‡ßá‡¶∞ ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶¨‡¶æ‡¶ß‡ßç‡¶Ø‡¶§‡¶æ‡¶Æ‡ßÇ‡¶≤‡¶ï ‡¶ï‡¶ø‡¶®‡¶æ
            </div>
        </div>
        
        <button onclick="saveSettings()" style="background: var(--primary-color); color: white; margin-top: 20px;">
            <i class="fas fa-save"></i> ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>
        
        <button onclick="toggleSettingsMenu()" style="background: var(--danger-color); color: white; margin-top: 10px;">
            <i class="fas fa-times"></i> ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>
    </div>

<div class="glow-title">MS EDUCATION</div>

<div class="teacher-info">
    ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï:‚Äì <strong><span class="teacher-name-display"></span></strong><br>
    <i class="fas fa-mosque" style="color: var(--primary-color);"></i> <span class="teacher-school-display"></span>
</div>

<div style="display: flex; gap: 5px; margin-bottom: 10px;">
    <button class="teacher-nav-btn" id="toggleNewExamBtn" onclick="toggleTeacherPanel('newExam')" style="background: var(--success-color) !important; flex-grow: 1;"><i class="fas fa-plus"></i> ‡¶®‡¶§‡ßÅ‡¶®</button>
    <button class="teacher-nav-btn" id="toggleSavedExamBtn" onclick="toggleTeacherPanel('savedExams')" style="background: var(--info-color) !important; flex-grow: 1;"><i class="fas fa-list-alt"></i> ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§</button>
    <button class="teacher-nav-btn" id="toggleResultBtn" onclick="toggleTeacherPanel('results')" style="background: var(--danger-color) !important; flex-grow: 1;"><i class="fas fa-poll-h"></i> ‡¶´‡¶≤‡¶æ‡¶´‡¶≤</button>
    <button class="teacher-nav-btn" id="toggleToolsBtn" onclick="toggleTeacherPanel('tools')" style="background: #FF9800 !important; flex-grow: 1;"><i class="fas fa-tools"></i> ‡¶ü‡ßÅ‡¶≤‡¶∏</button>
</div>

<div id="newExamPanel">
    <h2 style="margin-top: 15px;"><i class="fas fa-chalkboard-teacher"></i> ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶§‡ßà‡¶∞‡¶ø/‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ</h2>
    <p id="examIdDisplay" style="text-align: center; color: var(--danger-color); font-weight: bold; margin-bottom: 10px; display: none;"></p>
    
    <div class="input-group">
    <input type="text" id="examTitle" placeholder="‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
    </div>
    <div class="input-group">
    <input type="number" id="examDuration" placeholder="‡¶∏‡¶Æ‡¶Ø‡¶º‡¶∏‡ßÄ‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶® (‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü‡ßá)">
    </div>
    
    <div class="input-group">
        <label>‡¶≤‡ßã‡¶ó‡ßã ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶® (PDF-‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø):</label>
        <input type="file" id="logoUploadInput" accept="image/*">
        <p style="font-size: 12px; color: #666; margin-top: 5px;">‡¶™‡¶ø‡¶°‡¶ø‡¶è‡¶´ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶™‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶∂‡ßÄ‡¶∞‡ßç‡¶∑‡ßá ‡¶≤‡ßã‡¶ó‡ßã ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</p>
    </div>
    
    <p class="warning" style="text-align: center; font-weight: 700; color: var(--danger-color); font-size: 15px;"><i class="fas fa-exclamation-triangle"></i> ‡¶¨‡ßÄ‡¶ú‡¶ó‡¶£‡¶ø‡¶§, ‡¶ó‡¶£‡¶ø‡¶§ ‡¶ì ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶≤‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø $ (A+B)^2 $ ‡¶¨‡¶æ $$ \int x^2 dx $$ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>

    <div id="questionForms">
    </div>
    <button id="addQuestionBtn" onclick="addQuestion()"><i class="fas fa-plus-circle"></i> ‡¶Ü‡¶∞‡¶ì ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    
    <button id="saveOrUpdateExamBtn" onclick="saveExam(false)"><i class="fas fa-save"></i> ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶® / ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    
    <button id="generateLinkBtn" onclick="saveExam(true)" style="display:none; background: var(--success-color);"><i class="fas fa-link"></i> ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    
    <button id="printExamBtn" onclick="printNewExamQuestions()" style="display:none; background: #673AB7; color: white;"><i class="fas fa-print"></i> ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶™‡¶§‡ßç‡¶∞ PDF (‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®)</button>

    <div id="examLinkContainer" style="display:none; margin-top: 20px;">
    <hr>
    <div class="glow-title" style="font-size: 30px;">‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï</div>
    <div id="examLink" class="link-box" style="word-wrap: break-word; font-size: 14px;"></div>

    <button class="share-btn" onclick="shareLink()"><i class="fas fa-share-alt"></i> ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
</div>

<div id="savedExamsPanel" style="display:none;">
    <h2 style="margin-top: 15px;"><i class="fas fa-clipboard-list"></i> ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ</h2>
    <p style="text-align: center; color: var(--primary-color); font-weight: 700; font-size: 14px;">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶®‡¶ø‡¶ö‡ßá ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶®‡¶ø‡¶® ‡¶¨‡ßã‡¶§‡¶æ‡¶Æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
    <div id="savedExamsList"></div>
</div>

<div id="resultPanel" style="display:none;">
    <h2 style="margin-top: 15px;"><i class="fas fa-poll-h"></i> ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤</h2>
    <button class="teacher-nav-btn" onclick="updateResultTable()" style="background: var(--success-color) !important; margin-top: 0; width: 50%; margin: 0 auto 10px auto;"><i class="fas fa-sync-alt"></i> ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</button>

    <div class="table-container">
        <table id="resultTable">
            <tr>
                <th>‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ</th><th>‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</th><th>‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ</th><th>‡¶∏‡ßç‡¶ï‡ßã‡¶∞</th><th>‡¶ó‡ßç‡¶∞‡ßá‡¶°</th><th>‡¶∏‡¶Æ‡¶Ø‡¶º</th><th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
            </tr>
        </table>
    </div>
</div>

<div id="toolsPanel" style="display:none;">
    <h2 style="margin-top: 15px;"><i class="fas fa-tools"></i> ‡¶ü‡ßÅ‡¶≤‡¶∏</h2>
    <p style="text-align: center; color: var(--primary-color); font-weight: 700; font-size: 14px;">‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶ü‡ßÅ‡¶≤‡¶∏ (‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®)</p>
    
    <div class="tool-item">
        <h3 style="color: var(--primary-color); margin-top: 0;">‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™</h3>
        <p>‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶® (JSON ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá)‡•§</p>
        <button onclick="backupData()" class="tools-btn"><i class="fas fa-download"></i> ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button>
    </div>
    
    <div class="tool-item">
        <h3 style="color: var(--primary-color); margin-top: 0;">‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞</h3>
        <p>‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡ßÅ‡¶®‡¶∞‡ßÅ‡¶¶‡ßç‡¶ß‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶ì‡¶≠‡¶æ‡¶∞‡¶∞‡¶æ‡¶á‡¶ü ‡¶π‡¶¨‡ßá)‡•§</p>
        <input type="file" id="restoreFile" accept=".json" style="margin-bottom: 10px; width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
        <button onclick="restoreData()" class="tools-btn"><i class="fas fa-upload"></i> ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
    
    <div class="tool-item">
        <h3 style="color: var(--primary-color); margin-top: 0;">‡¶¨‡¶æ‡¶≤‡ßç‡¶ï ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Ü‡¶™‡¶≤‡ßã‡¶°</h3>
        <p>‡¶è‡¶ï‡¶∏‡¶æ‡¶•‡ßá ‡¶Ö‡¶®‡ßá‡¶ï‡¶ó‡ßÅ‡¶≤‡ßã ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
        <button onclick="bulkQuestionUpload()" class="tools-btn"><i class="fas fa-file-import"></i> ‡¶¨‡¶æ‡¶≤‡ßç‡¶ï ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Ü‡¶™‡¶≤‡ßã‡¶°</button>
    </div>
    
    <div class="tool-item danger">
        <h3 style="color: var(--danger-color); margin-top: 0;">‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</h3>
        <p>‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶® (‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶ó‡ßÅ‡¶≤‡ßã ‡¶•‡¶æ‡¶ï‡¶¨‡ßá)‡•§</p>
        <button onclick="clearAllResults()" class="tools-btn" style="background: var(--danger-color) !important;"><i class="fas fa-trash-alt"></i> ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
    </div>
    
    <div class="tool-item danger">
        <h3 style="color: var(--danger-color); margin-top: 0;">‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</h3>
        <p>‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶§‡¶æ‡¶¶‡ßá‡¶∞ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®‡•§</p>
        <button onclick="clearAllExams()" class="tools-btn" style="background: var(--danger-color) !important;"><i class="fas fa-trash-alt"></i> ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
    </div>
    
    <div class="tool-item danger">
        <h3 style="color: var(--danger-color); margin-top: 0;">‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü</h3>
        <p>‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶® (‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ, ‡¶´‡¶≤‡¶æ‡¶´‡¶≤, ‡¶ö‡ßá‡¶ï‡¶∏) ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
        <button onclick="resetSystem()" class="tools-btn" style="background: #000 !important;"><i class="fas fa-bomb"></i> ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü</button>
    </div>
</div>

</div>

<div id="studentStart" style="display:none;">
<div class="glow-title">MS EDUCATION</div>
<div class="teacher-info">
    ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï:‚Äì <strong><span class="teacher-name-display"></span></strong><br>
    <i class="fas fa-mosque" style="color: var(--primary-color);"></i> <span class="teacher-school-display"></span>
</div>
<h2 id="studentExamTitleDisplay"><i class="fas fa-file-alt"></i></h2>
<p style="text-align: center; font-size: 18px; color: var(--primary-color); font-weight: 700;">‡¶∏‡¶Æ‡¶Ø‡¶º‡¶∏‡ßÄ‡¶Æ‡¶æ: <span id="durationDisplay"></span> ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü</p>
<hr>

<div id="examFormContent">
    <div class="input-group">
    <label class="mandatory-label">‡¶õ‡¶æ‡¶§‡ßç‡¶∞/‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
    <input type="text" id="studentName" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßÅ‡¶∞‡ßã ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶Æ‡ßã‡¶¨‡¶æ‡¶∞‡¶æ‡¶ï ‡¶π‡ßã‡¶∏‡ßá‡¶®)">
    </div>

    <div class="input-group">
    <label class="mandatory-label">‡¶Ü‡¶™‡¶®‡¶ø:</label>
    <select id="studentGender">
    <option value="‡¶õ‡¶æ‡¶§‡ßç‡¶∞">‡¶õ‡¶æ‡¶§‡ßç‡¶∞</option>
    <option value="‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßÄ">‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßÄ</option>
    </select>
    </div>

    <div class="input-group">
    <label class="mandatory-label">‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ (Class):</label>
    <select id="studentClass">
    <option value="">-- ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
    <script>
        for (let i = 1; i <= 12; i++) {
            document.write(`<option value="Class ${i}">Class ${i}</option>`);
        }
    </script>
    </select>
    </div>
    <div class="input-group">
    <label class="mandatory-label">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞:</label>
    <input type="tel" id="studentMobile" placeholder="‡ßß‡ßß-‡¶°‡¶ø‡¶ú‡¶ø‡¶ü ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: 017xxxxxxxx)" maxlength="11" pattern="01[3-9][0-9]{8}" title="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡¶ü‡¶ø ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡ßß‡ßß-‡¶°‡¶ø‡¶ú‡¶ø‡¶ü-‡¶è‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç 013-019 ‡¶¶‡¶ø‡ßü‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§">
    </div>
    
    <!-- ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° (‡¶Ø‡¶¶‡¶ø ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶•‡¶æ‡¶ï‡ßá) -->
    <div id="studentPhotoUpload" style="display: none;">
        <div class="input-group">
            <label>‡¶õ‡¶æ‡¶§‡ßç‡¶∞/‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßÄ‡¶∞ ‡¶õ‡¶¨‡¶ø:</label>
            <input type="file" id="studentPhoto" accept="image/*">
            <p style="font-size: 12px; color: #666;">‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶õ‡¶¨‡¶ø ‡¶§‡ßÅ‡¶≤‡ßÅ‡¶®</p>
        </div>
    </div>
    
    <p style="text-align: center; color: var(--danger-color); font-weight: bold;">‚ö†Ô∏è ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶è‡¶ï‡¶¨‡¶æ‡¶∞ '‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®' ‡¶¨‡ßã‡¶§‡¶æ‡¶Æ‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶ó‡¶£‡¶®‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∞‡ßã‡¶ß ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá‡•§</p>
    <button onclick="startExam()"><i class="fas fa-play"></i> ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
</div>

<div id="examCompletedMessage" style="display: none;">
    <div id="completedMessageText"></div>
    <div id="duplicateContactBlock2"></div>
</div>
</div>

<div id="quiz" style="display:none;">
    <div class="quiz-header">
        <div class="moving-title">MS EDUCATION</div>
        
        <div class="teacher-info" id="quizTeacherInfo"></div>

        <h2 id="examTitleDisplay"></h2>
        
        <div class="timer" id="timerDisplay">‡¶∏‡¶Æ‡¶Ø‡¶º: 00:00</div> 
        <p style="text-align: center; font-size: 14px; color: var(--danger-color); font-weight: bold; margin: 5px 0 0 0;">‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶∏‡¶¨ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡¶ø‡¶®‡•§</p>
    </div>
    <div class="quiz-content">
        <form onsubmit="event.preventDefault(); submitAllAnswers(false);">
            <div id="questionsContainer">
                <p style="text-align: center;">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
            </div>
            
            <button type="submit" id="submitAllButton" style="background: var(--primary-color); color: white;">
                <i class="fas fa-paper-plane"></i> ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®
            </button>
        </form>
    </div>
</div>

<div id="result" style="display:none;">
    <h2><i class="fas fa-check-circle"></i> ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®</h2>
    
    <h3 id="resultTitleDisplay" style="text-align: center; font-size: 22px; color: var(--text-color); margin: 20px 0 0 0; font-weight: 800;"></h3>
    
    <div id="resultHiddenMessage" style="display: none;"></div>
    <div id="contactInfoBlock" style="margin-top: 30px; border-top: 1px dashed #ccc; padding-top: 20px;"></div>
</div>
</div>

<div id="default-message" style="display:none;">
    <div class="glow-title" style="font-size: 40px; margin-bottom: 25px;">MS EDUCATION</div>
    <h2 style="border-bottom: none;"><i class="fas fa-graduation-cap"></i> ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶æ‡¶≤</h2>
    <p style="text-align: center; font-size: 18px; color: var(--text-color); margin-bottom: 20px; font-weight: 700;">‡¶™‡ßç‡¶∞‡¶ø‡ßü ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ/‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï, ‡¶è‡¶ü‡¶ø ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶Æ‡ßÇ‡¶≤ ‡¶™‡¶æ‡¶§‡¶æ‡•§</p>
    <p style="font-size: 17px; line-height: 1.6;">‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶Ø‡¶º ‡¶Ö‡¶Ç‡¶∂ ‡¶®‡¶ø‡¶§‡ßá ‡¶π‡¶≤‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï‡ßá‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ **‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï‡ßá** (‡¶Ø‡ßá‡¶ü‡¶ø‡¶§‡ßá `?id=` ‡¶•‡¶æ‡¶ï‡¶¨‡ßá) ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§</p>
    
    <div class="input-group" style="text-align: center; margin-top: 30px;">
        <p style="color: var(--danger-color); font-weight: 700;"><i class="fas fa-phone-volume"></i> ‡¶ï‡ßã‡¶®‡ßã ‡¶ú‡¶∞‡ßÅ‡¶∞‡¶ø ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
    </div>

    <hr style="margin-top: 30px;">
    <p style="font-size: 15px; color: #666; text-align: center;">**‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï‡¶¶‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø:** ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡¶§‡ßá ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï‡ßá ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤‡¶ø `?teacher` ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶Ö‡¶•‡¶¨‡¶æ **<a href="javascript:void(0);" onclick="window.location.href = window.location.href.split('?')[0] + '?teacher';" style="color: var(--primary-color); font-weight: bold;">‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®</a>**‡•§</p>

    <div id="duplicateContactBlock"></div>

</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()"><i class="fas fa-times"></i></span>
        <div id="modalContent"></div>
        <div style="display: flex; gap: 10px;">
            <button id="pdfPrintBtn" style="background: var(--info-color); color: white; flex: 1;"><i class="fas fa-file-pdf"></i> PDF/‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button id="shareResultBtn" style="background: var(--success-color); color: white; flex: 1;"><i class="fas fa-share-alt"></i> ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶Ö‡¶™‡¶∂‡¶®</button>
        </div>
    </div>
</div>

<div id="diagramModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeDiagramModal()"><i class="fas fa-times"></i></span>
        <h3><i class="fas fa-pencil-ruler"></i> ‡¶ú‡ßç‡¶Ø‡¶æ‡¶Æ‡¶ø‡¶§‡¶ø‡¶ï ‡¶ö‡¶ø‡¶§‡ßç‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø‡¶∞ ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h3>
        
        <div class="canvas-controls">
            <div class="control-group">
                <label for="colorPicker">‡¶∞‡¶ô:</label>
                <input type="color" id="colorPicker" value="#000000">
            </div>
            <div class="control-group">
                <label for="brushSize">‡¶∏‡¶æ‡¶á‡¶ú:</label>
                <input type="range" id="brushSize" min="1" max="15" value="3">
            </div>
            <div class="control-group">
                <label for="drawingMode">‡¶°‡ßç‡¶∞‡ßü‡¶ø‡¶Ç ‡¶Æ‡ßã‡¶°:</label>
                <input type="checkbox" id="drawingMode" checked style="width: auto; height: auto;">
            </div>
            <button class="utility-btn" onclick="clearCanvas()" style="background: var(--danger-color) !important; width: 100px; margin-top: 0;"><i class="fas fa-trash-alt"></i> ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞</button>
        </div>

        <button id="smartDrawingBtn" onclick="toggleSmartDrawing()" style="background: #ff9800 !important; color: white !important;">
            <i class="fas fa-lightbulb"></i> ‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶Æ‡ßã‡¶°: ‡¶Ö‡¶´ (‡¶π‡¶æ‡¶§‡ßá ‡¶Ü‡¶Å‡¶ï‡¶æ ‡¶≤‡¶æ‡¶á‡¶® ‡¶∏‡ßã‡¶ú‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®)
        </button>

        <hr style="margin: 10px 0; border-top: 1px dashed #ccc;">
        
        <h4><i class="fas fa-shapes"></i> ‡¶∂‡ßá‡¶™ ‡¶è‡¶¨‡¶Ç ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®:</h4>
        <div class="control-group-row">
            <button class="utility-btn" onclick="addCircle()" style="background: #00bcd4 !important;"><i class="fas fa-circle"></i> ‡¶¨‡ßÉ‡¶§‡ßç‡¶§</button>
            <button class="utility-btn" onclick="addTriangle()" style="background: #ffc107 !important;"><i class="fas fa-play"></i> ‡¶§‡ßç‡¶∞‡¶ø‡¶≠‡ßÅ‡¶ú</button>
        </div>

        <div class="text-input-group" style="margin-top: 10px;">
            <input type="text" id="geometricText" placeholder="‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü (‡¶Ø‡ßá‡¶Æ‡¶® A, B, C) ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
            <button class="utility-btn" onclick="addGeometricText()" style="background: #3f51b5 !important;"><i class="fas fa-font"></i> ‡¶Ø‡ßã‡¶ó</button>
        </div>
        <div class="text-input-group">
            <input type="text" id="angleInput" placeholder="‡¶ï‡ßã‡¶£ (‡¶Ø‡ßá‡¶Æ‡¶® 30, 90) ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
            <button class="utility-btn" onclick="addAngleText()" style="background: #8bc34a !important;"><i class="fas fa-angle-left"></i> ‡¶Ø‡ßã‡¶ó (‡¶ï‡ßã‡¶£)</button>
        </div>
        <hr style="margin: 10px 0; border-top: 1px dashed #ccc;">

        <div id="canvas-container">
            <canvas id="diagramCanvas"></canvas>
        </div>
        
        <button id="saveDiagramBtn" onclick="saveDiagram()" style="background: #5e35b1; color: white;">
            <i class="fas fa-save"></i> ‡¶ö‡¶ø‡¶§‡ßç‡¶∞ ‡¶∏‡ßá‡¶≠ ‡¶ì ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>

    </div>
</div>

<div id="bulkUploadModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeBulkUploadModal()"><i class="fas fa-times"></i></span>
        <h3><i class="fas fa-file-import"></i> ‡¶¨‡¶æ‡¶≤‡ßç‡¶ï ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Ü‡¶™‡¶≤‡ßã‡¶°</h3>
        
        <p style="color: var(--danger-color); font-weight: bold;"><i class="fas fa-info-circle"></i> ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶®‡¶æ:</p>
        <ul style="font-size: 14px; margin-left: 20px;">
            <li>‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡ßü‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶® (1., 2., ‡¶á‡¶§‡ßç‡¶Ø‡¶æ‡¶¶‡¶ø)</li>
            <li>‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶Ö‡¶™‡¶∂‡¶® ‡¶®‡¶§‡ßÅ‡¶® ‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶ï., ‡¶ñ., ‡¶ó., ‡¶ò.)</li>
            <li>‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶´‡¶æ‡¶Å‡¶ï‡¶æ ‡¶≤‡¶æ‡¶á‡¶® ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®</li>
        </ul>
        
        <textarea id="bulkQuestionsText" rows="20" placeholder="1. ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶∞‡¶æ‡¶ú‡¶ß‡¶æ‡¶®‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶ï‡ßÄ?
‡¶ï. ‡¶¢‡¶æ‡¶ï‡¶æ
‡¶ñ. ‡¶ö‡¶ü‡ßç‡¶ü‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ
‡¶ó. ‡¶∞‡¶æ‡¶ú‡¶∂‡¶æ‡¶π‡ßÄ
‡¶ò. ‡¶ñ‡ßÅ‡¶≤‡¶®‡¶æ

2. ‡ß®+‡ß® ‡¶ï‡¶§?
‡¶ï. ‡ß©
‡¶ñ. ‡ß™
‡¶ó. ‡ß´
‡¶ò. ‡ß¨" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin: 10px 0;"></textarea>
        
        <div style="display: flex; gap: 10px;">
            <button onclick="downloadTemplate()" style="background: var(--info-color); color: white; flex: 1;">
                <i class="fas fa-download"></i> ‡¶ü‡ßá‡¶Æ‡¶™‡ßç‡¶≤‡ßá‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
            </button>
            <button onclick="processBulkQuestions()" style="background: var(--success-color); color: white; flex: 1;">
                <i class="fas fa-upload"></i> ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶ï‡¶∞‡ßÅ‡¶®
            </button>
        </div>
    </div>
</div>

<div id="certificateModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <span class="close" onclick="closeModal()"><i class="fas fa-times"></i></span>
        <div id="certificateModalContent"></div>
    </div>
</div>

</body>
</html>